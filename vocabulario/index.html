<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VocabQuest ‚Äî Vocabul√°rio em Ingl√™s</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0f1117;
  --surface: #1a1d2e;
  --surface2: #252840;
  --border: #2e3150;
  --accent: #58cc02;
  --accent2: #ffd900;
  --accent3: #ff4b4b;
  --accent4: #1cb0f6;
  --accent5: #ce82ff;
  --text: #ffffff;
  --text2: #afafaf;
  --text3: #6b6b8a;
  --radius: 16px;
  --radius-sm: 10px;
}
body { font-family: 'Nunito', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
.screen { display: none; min-height: 100vh; }
.screen.active { display: flex; flex-direction: column; }

/* ===== HOME ===== */
#home-screen {
  background: linear-gradient(135deg, #0f1117 0%, #1a1d2e 50%, #12102b 100%);
  align-items: center;
  padding: 0 0 80px 0;
}
#home-screen::before {
  content:''; position:fixed; width:500px; height:500px; border-radius:50%;
  background:radial-gradient(circle,rgba(206,130,255,0.08) 0%,transparent 70%);
  top:-100px; right:-100px; pointer-events:none;
}

.home-inner { width:100%; max-width:520px; padding:32px 20px 20px; }
.game-logo { font-size:60px; text-align:center; margin-bottom:4px; animation:bounce 2s ease-in-out infinite; }
@keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
.game-title { font-size:42px; font-weight:900; text-align:center; background:linear-gradient(135deg,#ce82ff,#1cb0f6); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; margin-bottom:4px; }
.game-subtitle { font-size:13px; color:var(--text3); text-align:center; font-weight:700; letter-spacing:2px; text-transform:uppercase; margin-bottom:24px; }

.home-stats { display:flex; gap:12px; justify-content:center; margin-bottom:24px; }
.home-stat { background:var(--surface); border:2px solid var(--border); border-radius:var(--radius-sm); padding:10px 18px; text-align:center; }
.home-stat-value { font-size:22px; font-weight:900; color:var(--accent2); }
.home-stat-label { font-size:10px; color:var(--text3); font-weight:700; text-transform:uppercase; }

.section-label { font-size:12px; color:var(--text3); font-weight:700; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; }

/* Categories grid */
.categories-grid { display:flex; flex-direction:column; gap:8px; margin-bottom:20px; }
.category-card {
  background:var(--surface);
  border:2px solid var(--border);
  border-radius:var(--radius-sm);
  padding:14px 16px;
  cursor:pointer;
  transition:all 0.15s;
  display:flex;
  align-items:center;
  gap:12px;
}
.category-card:hover { border-color:var(--accent5); background:rgba(206,130,255,0.08); transform:translateX(4px); }
.category-card.selected { border-color:var(--accent5); background:rgba(206,130,255,0.12); }
.cat-icon { font-size:26px; min-width:36px; text-align:center; }
.cat-info { flex:1; }
.cat-name { font-size:15px; font-weight:800; color:var(--text); }
.cat-count { font-size:12px; color:var(--text3); font-weight:600; }
.cat-check { font-size:18px; opacity:0; transition:opacity 0.2s; }
.category-card.selected .cat-check { opacity:1; }

.select-all-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.btn-text { background:none; border:none; color:var(--accent4); font-family:'Nunito',sans-serif; font-size:13px; font-weight:700; cursor:pointer; padding:4px 8px; }

/* Mode selector */
.mode-row { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:20px; }
.mode-btn {
  background:var(--surface); border:2px solid var(--border); border-radius:var(--radius-sm);
  padding:12px 10px; color:var(--text2); font-family:'Nunito',sans-serif; font-size:13px;
  font-weight:700; cursor:pointer; transition:all 0.15s; text-align:center;
}
.mode-btn:hover { border-color:var(--accent4); color:var(--text); }
.mode-btn.active { border-color:var(--accent4); background:rgba(28,176,246,0.1); color:var(--accent4); }
.mode-icon { font-size:20px; display:block; margin-bottom:3px; }

.btn-start {
  width:100%; background:var(--accent5); color:#fff;
  box-shadow:0 4px 0 #7a2faa;
  font-size:18px; padding:18px; border-radius:var(--radius-sm);
  font-family:'Nunito',sans-serif; font-weight:800; cursor:pointer; border:none;
  transition:all 0.15s; letter-spacing:0.5px;
}
.btn-start:hover { filter:brightness(1.1); }
.btn-start:active { transform:translateY(3px); box-shadow:none; }
.btn-start:disabled { background:var(--border); color:var(--text3); box-shadow:none; cursor:not-allowed; }

.home-nav { display:flex; gap:10px; margin-top:12px; }
.btn-nav { flex:1; background:var(--surface); border:2px solid var(--border); border-radius:var(--radius-sm); padding:12px; color:var(--text2); font-family:'Nunito',sans-serif; font-size:14px; font-weight:700; cursor:pointer; transition:all 0.15s; }
.btn-nav:hover { border-color:var(--accent4); color:var(--text); }

/* ===== GAME SCREEN ===== */
#game-screen { background:var(--bg); }
.game-header {
  display:flex; align-items:center; gap:10px; padding:14px 18px;
  background:var(--surface); border-bottom:2px solid var(--border);
  position:sticky; top:0; z-index:10;
}
.btn-back { background:var(--surface2); border:2px solid var(--border); border-radius:8px; padding:7px 12px; color:var(--text2); font-family:'Nunito',sans-serif; font-size:14px; font-weight:700; cursor:pointer; }
.btn-back:hover { color:var(--text); border-color:var(--accent4); }

.hud-lives { display:flex; gap:3px; }
.life-icon { font-size:20px; transition:transform 0.3s; }
.life-icon.lost { opacity:0.3; transform:scale(0.8); }

.hud-streak { display:flex; align-items:center; gap:4px; background:var(--surface2); padding:5px 10px; border-radius:20px; font-weight:800; font-size:13px; }
.hud-xp { flex:1; }
.xp-bar-wrap { background:var(--border); border-radius:20px; height:8px; overflow:hidden; }
.xp-bar-fill { height:100%; background:linear-gradient(90deg,var(--accent5),var(--accent4)); border-radius:20px; transition:width 0.5s cubic-bezier(0.34,1.56,0.64,1); }
.xp-label { font-size:10px; color:var(--text3); font-weight:700; text-align:right; margin-bottom:2px; }
.hud-level { background:var(--accent5); color:#fff; border-radius:20px; padding:4px 10px; font-weight:900; font-size:12px; white-space:nowrap; }

.game-body { flex:1; padding:20px 18px; max-width:660px; margin:0 auto; width:100%; display:flex; flex-direction:column; gap:18px; }

.progress-top { background:var(--border); border-radius:20px; height:7px; overflow:hidden; }
.progress-top-fill { height:100%; background:linear-gradient(90deg,var(--accent5),var(--accent4)); border-radius:20px; transition:width 0.4s ease; }

/* category tag */
.cat-tag { display:inline-flex; align-items:center; gap:6px; padding:5px 12px; border-radius:20px; font-size:12px; font-weight:800; text-transform:uppercase; letter-spacing:0.5px; background:rgba(206,130,255,0.12); color:var(--accent5); border:1px solid rgba(206,130,255,0.3); margin-bottom:12px; }

/* Question card */
.question-card { background:var(--surface); border:2px solid var(--border); border-radius:var(--radius); padding:24px 22px; animation:slideIn 0.3s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes slideIn { from{opacity:0;transform:translateY(20px) scale(0.97)} to{opacity:1;transform:translateY(0) scale(1)} }

.q-instruction { font-size:14px; color:var(--text2); margin-bottom:16px; font-weight:600; line-height:1.6; }
.q-instruction strong { color:var(--text); }

/* Word card display */
.word-display {
  text-align:center; padding:20px 16px; margin-bottom:6px;
}
.word-main { font-size:36px; font-weight:900; color:var(--text); margin-bottom:4px; font-family:'Space Mono',monospace; }
.word-pron { font-size:15px; color:var(--accent4); font-style:italic; margin-bottom:6px; }
.word-pt { font-size:14px; color:var(--text3); }

/* For PT‚ÜíEN direction */
.word-main-pt { font-size:32px; font-weight:900; color:var(--accent2); margin-bottom:6px; }

/* Fill input */
.blank-input {
  background:var(--surface2); border:2px solid var(--accent4); border-radius:var(--radius-sm);
  color:var(--text); font-family:'Space Mono',monospace; font-size:18px; padding:12px 16px;
  width:100%; outline:none; transition:border-color 0.2s,box-shadow 0.2s; caret-color:var(--accent4);
  text-align:center;
}
.blank-input:focus { border-color:var(--accent4); box-shadow:0 0 0 3px rgba(28,176,246,0.15); }
.blank-input.correct { border-color:var(--accent); background:rgba(88,204,2,0.08); }
.blank-input.wrong { border-color:var(--accent3); background:rgba(255,75,75,0.08); }

/* Choices */
.choices-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:6px; }
.choice-btn {
  background:var(--surface2); border:2px solid var(--border); border-radius:var(--radius-sm);
  color:var(--text); font-family:'Space Mono',monospace; font-size:14px; font-weight:700;
  padding:14px 10px; cursor:pointer; transition:all 0.15s; text-align:center; line-height:1.3;
}
.choice-btn:hover:not(:disabled) { border-color:var(--accent4); background:rgba(28,176,246,0.1); transform:translateY(-2px); }
.choice-btn.correct-choice { border-color:var(--accent); background:rgba(88,204,2,0.15); color:#7be338; }
.choice-btn.wrong-choice { border-color:var(--accent3); background:rgba(255,75,75,0.15); color:#ff8080; }
.choice-btn:disabled { cursor:not-allowed; }

/* Match pairs */
.match-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.match-col { display:flex; flex-direction:column; gap:8px; }
.match-item {
  background:var(--surface2); border:2px solid var(--border); border-radius:var(--radius-sm);
  padding:12px 14px; cursor:pointer; transition:all 0.15s; text-align:center;
  font-weight:700; font-size:14px; user-select:none;
}
.match-item:hover { border-color:var(--accent5); }
.match-item.selected-a { border-color:var(--accent5); background:rgba(206,130,255,0.15); color:var(--accent5); }
.match-item.matched { border-color:var(--accent); background:rgba(88,204,2,0.12); color:#7be338; pointer-events:none; }
.match-item.wrong-match { border-color:var(--accent3); animation:shake 0.3s; }
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

/* Word arrangement */
.answer-row { display:flex; flex-wrap:wrap; gap:7px; min-height:46px; padding:10px; background:rgba(28,176,246,0.05); border-radius:var(--radius-sm); border:2px solid var(--accent4); margin-bottom:8px; }
.word-bank { display:flex; flex-wrap:wrap; gap:7px; min-height:46px; padding:10px; background:var(--surface2); border-radius:var(--radius-sm); border:2px dashed var(--border); }
.word-token { background:var(--surface); border:2px solid var(--border); border-radius:7px; padding:7px 12px; font-family:'Space Mono',monospace; font-size:13px; font-weight:700; cursor:pointer; transition:all 0.15s; color:var(--text); user-select:none; }
.word-token:hover { border-color:var(--accent4); color:var(--accent4); transform:translateY(-2px); }
.word-token.used { opacity:0.3; pointer-events:none; }
.answer-token { background:rgba(28,176,246,0.15); border:2px solid var(--accent4); border-radius:7px; padding:7px 12px; font-family:'Space Mono',monospace; font-size:13px; font-weight:700; cursor:pointer; color:var(--accent4); user-select:none; transition:all 0.15s; }
.answer-token:hover { background:rgba(255,75,75,0.15); border-color:var(--accent3); color:#ff8080; }

/* Feedback */
.feedback-panel { border-radius:var(--radius); padding:18px 22px; animation:slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes slideUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
.feedback-panel.correct-panel { background:rgba(88,204,2,0.1); border:2px solid rgba(88,204,2,0.4); }
.feedback-panel.wrong-panel { background:rgba(255,75,75,0.1); border:2px solid rgba(255,75,75,0.4); }
.feedback-header { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
.feedback-icon { font-size:26px; }
.feedback-title { font-size:18px; font-weight:900; }
.feedback-panel.correct-panel .feedback-title { color:var(--accent); }
.feedback-panel.wrong-panel .feedback-title { color:var(--accent3); }
.feedback-correct-answer { background:var(--surface2); border-radius:var(--radius-sm); padding:10px 14px; margin-bottom:10px; font-family:'Space Mono',monospace; font-size:15px; font-weight:700; color:var(--accent4); border-left:4px solid var(--accent4); }
.feedback-info { font-size:13px; color:var(--text2); line-height:1.7; }
.feedback-info strong { color:var(--text); }
.feedback-pron { display:inline-block; background:rgba(28,176,246,0.1); border-radius:6px; padding:3px 10px; color:var(--accent4); font-size:13px; margin-top:4px; }
.feedback-motivation { font-size:14px; font-weight:700; color:var(--accent2); margin-top:8px; }

/* Footer */
.game-footer { padding:14px 18px; max-width:660px; margin:0 auto; width:100%; position:sticky; bottom:0; background:var(--bg); border-top:2px solid var(--border); }
.btn-check { width:100%; background:var(--accent5); color:#fff; box-shadow:0 4px 0 #7a2faa; font-size:17px; padding:17px; border-radius:var(--radius-sm); font-family:'Nunito',sans-serif; font-weight:800; cursor:pointer; border:none; transition:all 0.15s; }
.btn-check:hover { filter:brightness(1.1); }
.btn-check:active { transform:translateY(3px); box-shadow:none; }
.btn-check:disabled { background:var(--border); color:var(--text3); box-shadow:none; cursor:not-allowed; }
.btn-next { width:100%; background:var(--accent4); color:#fff; box-shadow:0 4px 0 #0a6b9a; font-size:17px; padding:17px; border-radius:var(--radius-sm); font-family:'Nunito',sans-serif; font-weight:800; cursor:pointer; border:none; transition:all 0.15s; display:none; }
.btn-next:hover { filter:brightness(1.1); }
.btn-next:active { transform:translateY(3px); box-shadow:none; }

/* Match special footer */
.match-info { text-align:center; font-size:14px; color:var(--text3); font-weight:600; padding:12px; }

/* ===== STATS / RANKING ===== */
#stats-screen, #ranking-screen { background:var(--bg); }
.page-header { padding:22px 20px 14px; display:flex; align-items:center; gap:12px; border-bottom:2px solid var(--border); }
.page-title { font-size:26px; font-weight:900; flex:1; }
.page-body { flex:1; padding:22px 20px; max-width:580px; margin:0 auto; width:100%; overflow-y:auto; }

.stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:22px; }
.stat-card { background:var(--surface); border:2px solid var(--border); border-radius:var(--radius); padding:14px; text-align:center; }
.stat-card-icon { font-size:28px; margin-bottom:6px; }
.stat-card-value { font-size:26px; font-weight:900; }
.stat-card-label { font-size:11px; color:var(--text3); font-weight:700; text-transform:uppercase; margin-top:3px; }

.achievements-title { font-size:18px; font-weight:900; margin-bottom:14px; }
.achievements-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:22px; }
.achievement { background:var(--surface); border:2px solid var(--border); border-radius:var(--radius-sm); padding:12px 8px; text-align:center; transition:all 0.2s; }
.achievement.unlocked { border-color:var(--accent2); background:rgba(255,217,0,0.05); }
.achievement-icon { font-size:26px; margin-bottom:5px; filter:grayscale(100%) opacity(0.3); }
.achievement.unlocked .achievement-icon { filter:none; }
.achievement-name { font-size:10px; font-weight:700; color:var(--text3); }
.achievement.unlocked .achievement-name { color:var(--text2); }

.cat-progress-title { font-size:18px; font-weight:900; margin-bottom:14px; }
.cat-progress-item { display:flex; align-items:center; gap:10px; background:var(--surface); border:2px solid var(--border); border-radius:var(--radius-sm); padding:12px 14px; margin-bottom:8px; }
.cat-progress-icon { font-size:22px; }
.cat-progress-info { flex:1; }
.cat-progress-name { font-size:13px; font-weight:800; margin-bottom:4px; }
.cat-progress-bar-wrap { background:var(--border); border-radius:20px; height:6px; overflow:hidden; }
.cat-progress-bar-fill { height:100%; background:linear-gradient(90deg,var(--accent5),var(--accent4)); border-radius:20px; }
.cat-progress-num { font-size:12px; font-weight:900; color:var(--accent5); }

/* ranking */
.podium { display:flex; align-items:flex-end; justify-content:center; gap:8px; margin-bottom:28px; }
.podium-place { display:flex; flex-direction:column; align-items:center; gap:7px; }
.podium-avatar { width:54px; height:54px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:26px; border:3px solid; }
.podium-1 .podium-avatar { border-color:#ffd900; background:rgba(255,217,0,0.15); }
.podium-2 .podium-avatar { border-color:#aaa; background:rgba(170,170,170,0.1); }
.podium-3 .podium-avatar { border-color:#cd7f32; background:rgba(205,127,50,0.1); }
.podium-name { font-size:12px; font-weight:700; color:var(--text2); text-align:center; }
.podium-score { font-size:13px; font-weight:900; }
.podium-1 .podium-score { color:var(--accent2); }
.podium-2 .podium-score { color:#aaa; }
.podium-3 .podium-score { color:#cd7f32; }
.podium-block { border-radius:8px 8px 0 0; width:76px; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:900; }
.podium-1 .podium-block { height:85px; background:rgba(255,217,0,0.12); border:2px solid rgba(255,217,0,0.3); }
.podium-2 .podium-block { height:62px; background:rgba(170,170,170,0.07); border:2px solid rgba(170,170,170,0.2); }
.podium-3 .podium-block { height:48px; background:rgba(205,127,50,0.07); border:2px solid rgba(205,127,50,0.2); }
.rank-list { display:flex; flex-direction:column; gap:7px; }
.rank-item { display:flex; align-items:center; gap:12px; background:var(--surface); border:2px solid var(--border); border-radius:var(--radius-sm); padding:12px 14px; }
.rank-item.is-you { border-color:var(--accent5); background:rgba(206,130,255,0.05); }
.rank-num { font-size:16px; font-weight:900; color:var(--text3); width:24px; text-align:center; }
.rank-avatar { font-size:26px; }
.rank-info { flex:1; }
.rank-name { font-weight:800; font-size:14px; }
.rank-level { font-size:11px; color:var(--text3); font-weight:600; }
.rank-score { font-size:16px; font-weight:900; color:var(--accent2); }

/* game over */
#gameover-screen { background:var(--bg); align-items:center; justify-content:center; }
.go-inner { text-align:center; padding:40px 20px; max-width:380px; }
.go-icon { font-size:72px; margin-bottom:14px; animation:shake 0.5s ease-in-out; }
.go-title { font-size:30px; font-weight:900; color:var(--accent3); margin-bottom:8px; }
.go-text { font-size:15px; color:var(--text2); margin-bottom:22px; line-height:1.6; }
.go-score { background:var(--surface); border:2px solid var(--border); border-radius:var(--radius); padding:14px 22px; margin-bottom:22px; }
.go-score-row { display:flex; justify-content:space-between; align-items:center; padding:5px 0; }
.go-score-label { font-size:13px; color:var(--text2); font-weight:600; }
.go-score-value { font-size:16px; font-weight:900; color:var(--accent2); }
.go-btns { display:flex; flex-direction:column; gap:10px; }
.btn-restart { width:100%; background:var(--accent5); color:#fff; box-shadow:0 4px 0 #7a2faa; font-size:16px; padding:16px; border-radius:var(--radius-sm); font-family:'Nunito',sans-serif; font-weight:800; cursor:pointer; border:none; transition:all 0.15s; }
.btn-menu { width:100%; background:var(--surface); color:var(--text2); border:2px solid var(--border); font-size:15px; padding:14px; border-radius:var(--radius-sm); font-family:'Nunito',sans-serif; font-weight:700; cursor:pointer; transition:all 0.15s; }
.btn-menu:hover { color:var(--text); border-color:var(--accent4); }

/* floaty */
.xp-popup { position:fixed; top:80px; right:18px; background:var(--accent2); color:#1a1d2e; font-weight:900; font-size:16px; padding:8px 18px; border-radius:20px; pointer-events:none; z-index:100; animation:xpFloat 1.5s ease-out forwards; }
@keyframes xpFloat { 0%{opacity:0;transform:translateY(0)} 20%{opacity:1} 80%{opacity:1;transform:translateY(-40px)} 100%{opacity:0;transform:translateY(-60px)} }
.streak-milestone { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-size:72px; z-index:300; pointer-events:none; animation:streakBurst 1.5s ease-out forwards; text-align:center; white-space:nowrap; }
@keyframes streakBurst { 0%{opacity:0;transform:translate(-50%,-50%) scale(0.3)} 30%{opacity:1;transform:translate(-50%,-50%) scale(1.3)} 60%{opacity:1;transform:translate(-50%,-50%) scale(1)} 100%{opacity:0;transform:translate(-50%,-70%) scale(0.8)} }
.toast { position:fixed; top:18px; left:50%; transform:translateX(-50%); background:var(--surface2); border:2px solid var(--border); border-radius:20px; padding:10px 22px; font-weight:800; font-size:14px; z-index:200; animation:toastAnim 2.5s ease forwards; white-space:nowrap; }
@keyframes toastAnim { 0%{opacity:0;transform:translateX(-50%) translateY(-10px)} 15%{opacity:1;transform:translateX(-50%) translateY(0)} 70%{opacity:1} 100%{opacity:0;transform:translateX(-50%) translateY(-10px)} }

::-webkit-scrollbar { width:5px; }
::-webkit-scrollbar-track { background:var(--bg); }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

@media(max-width:480px) { .choices-grid{grid-template-columns:1fr} .word-main{font-size:28px} }

/* ===== STUDY SCREEN ===== */
#study-screen { background: var(--bg); }

.study-header {
  padding: 16px 18px;
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--surface);
  border-bottom: 2px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 10;
}
.study-header-info { flex: 1; }
.study-header-title { font-size: 18px; font-weight: 900; line-height: 1.2; }
.study-header-sub { font-size: 12px; color: var(--text3); font-weight: 600; margin-top: 2px; }

.study-body {
  flex: 1;
  overflow-y: auto;
  padding: 20px 16px 0;
  max-width: 680px;
  margin: 0 auto;
  width: 100%;
}

/* Search bar */
.study-search-wrap {
  position: relative;
  margin-bottom: 16px;
}
.study-search {
  width: 100%;
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: 'Nunito', sans-serif;
  font-size: 14px;
  font-weight: 600;
  padding: 10px 16px 10px 40px;
  outline: none;
  transition: border-color 0.2s;
}
.study-search:focus { border-color: var(--accent5); }
.study-search::placeholder { color: var(--text3); }
.study-search-icon {
  position: absolute;
  left: 13px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 16px;
  pointer-events: none;
}

/* Vocab table */
.vocab-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}
.vocab-table thead tr {
  background: var(--surface2);
  border-bottom: 2px solid var(--border);
}
.vocab-table thead th {
  padding: 10px 14px;
  text-align: left;
  font-size: 11px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text3);
}
.vocab-table thead th:first-child { border-radius: 8px 0 0 0; }
.vocab-table thead th:last-child { border-radius: 0 8px 0 0; }

.vocab-row {
  border-bottom: 1px solid var(--border);
  transition: background 0.12s;
  cursor: default;
}
.vocab-row:hover { background: rgba(206,130,255,0.06); }
.vocab-row:last-child { border-bottom: none; }

.vocab-row td {
  padding: 11px 14px;
  vertical-align: middle;
}

.cell-num {
  font-size: 12px;
  font-weight: 700;
  color: var(--text3);
  width: 32px;
  text-align: center;
}

.cell-en {
  font-family: 'Space Mono', monospace;
  font-size: 15px;
  font-weight: 700;
  color: var(--text);
}

.cell-pron {
  font-size: 13px;
  color: var(--accent4);
  font-style: italic;
  font-weight: 600;
}

.cell-pt {
  font-size: 14px;
  font-weight: 700;
  color: var(--accent2);
}

/* Card view for alphabet */
.alphabet-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(88px, 1fr));
  gap: 8px;
  margin-bottom: 20px;
}
.alphabet-card {
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px 8px;
  text-align: center;
  transition: all 0.15s;
}
.alphabet-card:hover { border-color: var(--accent5); background: rgba(206,130,255,0.08); }
.alpha-letter { font-family: 'Space Mono', monospace; font-size: 28px; font-weight: 700; color: var(--text); line-height: 1; margin-bottom: 4px; }
.alpha-pron { font-size: 12px; color: var(--accent4); font-weight: 700; }

/* Color swatches for cores category */
.color-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 10px;
  margin-bottom: 20px;
}
.color-card {
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  overflow: hidden;
  transition: all 0.15s;
}
.color-card:hover { transform: translateY(-2px); border-color: var(--border); }
.color-swatch { height: 48px; width: 100%; }
.color-card-body { padding: 8px 10px; }
.color-en { font-family: 'Space Mono', monospace; font-size: 11px; font-weight: 700; color: var(--text); }
.color-pron { font-size: 10px; color: var(--accent4); font-style: italic; }
.color-pt { font-size: 11px; color: var(--accent2); font-weight: 700; margin-top: 2px; }

/* Color hex map */
.color-hex-map {
  Red: '#e74c3c', Yellow: '#f1c40f', Green: '#27ae60',
}

/* Study footer */
.study-footer {
  padding: 14px 18px;
  max-width: 680px;
  margin: 0 auto;
  width: 100%;
  background: var(--bg);
  border-top: 2px solid var(--border);
  position: sticky;
  bottom: 0;
  display: flex;
  gap: 10px;
}
.btn-study-start {
  flex: 1;
  background: var(--accent5);
  color: #fff;
  box-shadow: 0 4px 0 #7a2faa;
  font-size: 16px;
  padding: 16px;
  border-radius: var(--radius-sm);
  font-family: 'Nunito', sans-serif;
  font-weight: 800;
  cursor: pointer;
  border: none;
  transition: all 0.15s;
}
.btn-study-start:hover { filter: brightness(1.1); }
.btn-study-start:active { transform: translateY(3px); box-shadow: none; }
.btn-study-back {
  background: var(--surface);
  color: var(--text2);
  border: 2px solid var(--border);
  font-size: 15px;
  padding: 16px 20px;
  border-radius: var(--radius-sm);
  font-family: 'Nunito', sans-serif;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s;
}
.btn-study-back:hover { color: var(--text); border-color: var(--accent4); }

/* progress pill on category card */
.cat-studied-badge {
  font-size: 10px;
  font-weight: 700;
  background: rgba(88,204,2,0.15);
  color: var(--accent);
  border: 1px solid rgba(88,204,2,0.3);
  border-radius: 10px;
  padding: 2px 8px;
  margin-top: 3px;
  display: inline-block;
}

/* View toggle */
.view-toggle {
  display: flex;
  gap: 6px;
  background: var(--surface2);
  border-radius: var(--radius-sm);
  padding: 4px;
  margin-bottom: 14px;
}
.view-btn {
  flex: 1;
  background: none;
  border: none;
  color: var(--text3);
  font-family: 'Nunito', sans-serif;
  font-size: 12px;
  font-weight: 700;
  padding: 7px;
  border-radius: 7px;
  cursor: pointer;
  transition: all 0.15s;
}
.view-btn.active {
  background: var(--surface);
  color: var(--text);
  box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

/* Flashcard view */
.flashcard-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px 0 20px;
}
.flashcard {
  width: 100%;
  max-width: 360px;
  perspective: 800px;
  margin-bottom: 18px;
  cursor: pointer;
}
.flashcard-inner {
  position: relative;
  width: 100%;
  height: 200px;
  transform-style: preserve-3d;
  transition: transform 0.5s cubic-bezier(0.34,1.56,0.64,1);
}
.flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
.flashcard-front, .flashcard-back {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  border-radius: var(--radius);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px;
  border: 2px solid var(--border);
}
.flashcard-front {
  background: var(--surface);
}
.flashcard-back {
  background: linear-gradient(135deg, rgba(206,130,255,0.1), rgba(28,176,246,0.1));
  border-color: var(--accent5);
  transform: rotateY(180deg);
}
.fc-word { font-family: 'Space Mono', monospace; font-size: 32px; font-weight: 700; color: var(--text); margin-bottom: 8px; text-align: center; }
.fc-pron { font-size: 16px; color: var(--accent4); font-style: italic; text-align: center; }
.fc-translation { font-size: 28px; font-weight: 900; color: var(--accent2); text-align: center; margin-bottom: 8px; }
.fc-hint { font-size: 13px; color: var(--text3); font-weight: 600; }
.fc-tap { font-size: 12px; color: var(--text3); font-weight: 600; }
.flashcard-nav { display: flex; align-items: center; gap: 16px; }
.fc-nav-btn {
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: 50%;
  width: 44px; height: 44px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.15s;
  color: var(--text2);
}
.fc-nav-btn:hover { border-color: var(--accent5); color: var(--text); }
.fc-counter { font-size: 14px; font-weight: 800; color: var(--text2); min-width: 60px; text-align: center; }

@media(max-width:480px) {
  .vocab-table thead th, .vocab-row td { padding: 9px 10px; }
  .cell-en { font-size: 13px; }
  .alphabet-grid { grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); }
}
</style>
</head>
<body>

<!-- HOME -->
<div id="home-screen" class="screen active">
  <div class="home-inner">
    <div class="game-logo">üìö</div>
    <div class="game-title">VocabQuest</div>
    <div class="game-subtitle">Vocabul√°rio em Ingl√™s</div>

    <div class="home-stats">
      <div class="home-stat"><div class="home-stat-value" id="home-level">1</div><div class="home-stat-label">N√≠vel</div></div>
      <div class="home-stat"><div class="home-stat-value" id="home-xp">0</div><div class="home-stat-label">XP Total</div></div>
      <div class="home-stat"><div class="home-stat-value" id="home-streak">0</div><div class="home-stat-label">üî• Streak</div></div>
    </div>

    <div class="section-label">Modo de Jogo</div>
    <div class="mode-row">
      <button class="mode-btn active" data-mode="choice"><span class="mode-icon">üéØ</span>M√∫ltipla Escolha</button>
      <button class="mode-btn" data-mode="fill"><span class="mode-icon">‚úèÔ∏è</span>Complete a Palavra</button>
      <button class="mode-btn" data-mode="match"><span class="mode-icon">üîó</span>Combine Pares</button>
      <button class="mode-btn" data-mode="mix"><span class="mode-icon">üîÄ</span>Modo Misto</button>
    </div>

    <div class="select-all-row">
      <div class="section-label" style="margin:0">Categorias</div>
      <div style="display:flex;gap:4px;">
        <button class="btn-text" onclick="selectAllCats()">Selecionar todas</button>
        <button class="btn-text" onclick="deselectAllCats()">Limpar</button>
      </div>
    </div>
    <div class="categories-grid" id="categories-grid"></div>

    <button class="btn-start" id="btn-start" onclick="startGame()" disabled>‚ñ∂ Come√ßar Treino</button>
    <div class="home-nav">
      <button class="btn-nav" onclick="showScreen('ranking-screen');renderRanking()">üèÜ Ranking</button>
      <button class="btn-nav" onclick="showScreen('stats-screen');renderStats()">üìä Stats</button>
    </div>
  </div>
</div>

<!-- STUDY SCREEN -->
<div id="study-screen" class="screen">
  <div class="study-header">
    <button class="btn-back" onclick="showScreen('home-screen')">‚Üê</button>
    <div class="study-header-info">
      <div class="study-header-title" id="study-title">Dias da Semana</div>
      <div class="study-header-sub" id="study-sub">7 palavras</div>
    </div>
  </div>
  <div class="study-body" id="study-body"></div>
  <div class="study-footer">
    <button class="btn-study-back" onclick="showScreen('home-screen')">‚Üê Voltar</button>
    <button class="btn-study-start" onclick="startFromStudy()">‚úÖ J√° estudei! Iniciar Treino</button>
  </div>
</div>

<!-- GAME -->
<div id="game-screen" class="screen">
  <div class="game-header">
    <button class="btn-back" onclick="showScreen('home-screen')">‚Üê</button>
    <div class="hud-lives" id="hud-lives"></div>
    <div class="hud-streak"><span>üî•</span><span id="streak-count">0</span></div>
    <div class="hud-xp">
      <div class="xp-label" id="xp-label">XP: 0/100</div>
      <div class="xp-bar-wrap"><div class="xp-bar-fill" id="xp-bar" style="width:0%"></div></div>
    </div>
    <div class="hud-level" id="hud-level">Lv.1</div>
  </div>
  <div class="game-body">
    <div class="progress-top"><div class="progress-top-fill" id="progress-fill" style="width:0%"></div></div>
    <div id="question-container"></div>
    <div id="feedback-container" style="display:none"></div>
  </div>
  <div class="game-footer">
    <button class="btn-check" id="btn-check" onclick="checkAnswer()" disabled>VERIFICAR</button>
    <button class="btn-next" id="btn-next" onclick="nextQuestion()">CONTINUAR ‚Üí</button>
  </div>
</div>

<!-- STATS -->
<div id="stats-screen" class="screen">
  <div class="page-header">
    <button class="btn-back" onclick="showScreen('home-screen')">‚Üê</button>
    <div class="page-title">üìä Estat√≠sticas</div>
  </div>
  <div class="page-body">
    <div class="stats-grid" id="stats-grid"></div>
    <div class="cat-progress-title">üìÇ Progresso por Categoria</div>
    <div id="cat-progress-list"></div>
    <div class="achievements-title">üéñ Conquistas</div>
    <div class="achievements-grid" id="achievements-grid"></div>
  </div>
</div>

<!-- RANKING -->
<div id="ranking-screen" class="screen">
  <div class="page-header">
    <button class="btn-back" onclick="showScreen('home-screen')">‚Üê</button>
    <div class="page-title">üèÜ Ranking Semanal</div>
  </div>
  <div class="page-body">
    <div class="podium" id="podium"></div>
    <div class="rank-list" id="rank-list"></div>
  </div>
</div>

<!-- GAME OVER -->
<div id="gameover-screen" class="screen">
  <div class="go-inner">
    <div class="go-icon">üíî</div>
    <div class="go-title">Sem Vidas!</div>
    <div class="go-text">N√£o desista! Cada erro √© uma chance de aprender. Revise e tente novamente!</div>
    <div class="go-score">
      <div class="go-score-row"><span class="go-score-label">Palavras respondidas</span><span class="go-score-value" id="go-total">0</span></div>
      <div class="go-score-row"><span class="go-score-label">Acertos</span><span class="go-score-value" id="go-correct">0</span></div>
      <div class="go-score-row"><span class="go-score-label">XP Ganho</span><span class="go-score-value" id="go-xp">0</span></div>
      <div class="go-score-row"><span class="go-score-label">Maior Streak</span><span class="go-score-value" id="go-streak">0</span></div>
    </div>
    <div class="go-btns">
      <button class="btn-restart" onclick="startGame()">üîÑ Tentar Novamente</button>
      <button class="btn-menu" onclick="showScreen('home-screen')">‚Üê Menu Principal</button>
    </div>
  </div>
</div>

<script>
// =====================================================
// ============= VOCABULARY DATABASE ==================
// =====================================================

const CATEGORIES = [
  {
    id: 'alfabeto',
    name: 'Alfabeto',
    icon: 'üî§',
    color: '#ce82ff',
    words: [
      {en:'A',pron:'EI',pt:'EI'},
      {en:'B',pron:'BI',pt:'BI'},
      {en:'C',pron:'CI',pt:'CI'},
      {en:'D',pron:'DI',pt:'DI'},
      {en:'E',pron:'I',pt:'I'},
      {en:'F',pron:'√âF',pt:'√âF'},
      {en:'G',pron:'DJI',pt:'DJI'},
      {en:'H',pron:'EITCH',pt:'EITCH'},
      {en:'I',pron:'AI',pt:'AI'},
      {en:'J',pron:'DJEI',pt:'DJEI'},
      {en:'K',pron:'KEI',pt:'KEI'},
      {en:'L',pron:'EL',pt:'EL'},
      {en:'M',pron:'EM',pt:'EM'},
      {en:'N',pron:'EN',pt:'EN'},
      {en:'O',pron:'OU',pt:'OU'},
      {en:'P',pron:'PI',pt:'PI'},
      {en:'Q',pron:'QUIU',pt:'QUIU'},
      {en:'R',pron:'AR',pt:'AR'},
      {en:'S',pron:'ES',pt:'ES'},
      {en:'T',pron:'TI',pt:'TI'},
      {en:'U',pron:'IU',pt:'IU'},
      {en:'V',pron:'VI',pt:'VI'},
      {en:'W',pron:'D√ÇBLIU',pt:'D√ÇBLIU'},
      {en:'X',pron:'√âCS',pt:'√âCS'},
      {en:'Y',pron:'UAI',pt:'UAI'},
      {en:'Z',pron:'ZI',pt:'ZI'}
    ]
  },
  {
    id: 'numeros',
    name: 'N√∫meros',
    icon: 'üî¢',
    color: '#1cb0f6',
    words: [
      {en:'One',pron:'u√≥n',pt:'1'},
      {en:'Two',pron:'tch√∫',pt:'2'},
      {en:'Three',pron:'thrii',pt:'3'},
      {en:'Four',pron:'f√≥r',pt:'4'},
      {en:'Five',pron:'f√°iv',pt:'5'},
      {en:'Six',pron:'siks',pt:'6'},
      {en:'Seven',pron:'s√©ven',pt:'7'},
      {en:'Eight',pron:'√©igt',pt:'8'},
      {en:'Nine',pron:'n√°in',pt:'9'},
      {en:'Ten',pron:'t√©n',pt:'10'},
      {en:'Eleven',pron:'el√©v√™n',pt:'11'},
      {en:'Twelve',pron:'tu√©lv',pt:'12'},
      {en:'Thirteen',pron:'t√†rtiin',pt:'13'},
      {en:'Fourteen',pron:'f√≥rtiin',pt:'14'},
      {en:'Fifteen',pron:'fiftiin',pt:'15'},
      {en:'Sixteen',pron:'sikstiin',pt:'16'},
      {en:'Seventeen',pron:'s√©ventiin',pt:'17'},
      {en:'Eighteen',pron:'√©igtiin',pt:'18'},
      {en:'Nineteen',pron:'n√°intiin',pt:'19'},
      {en:'Twenty',pron:'tu√©ni',pt:'20'},
      {en:'Twenty-one',pron:'tu√©ni u√≥n',pt:'21'},
      {en:'Twenty-two',pron:'tu√©ni ti√∫',pt:'22'},
      {en:'Twenty-three',pron:'tu√©ni thrii',pt:'23'},
      {en:'Twenty-four',pron:'tu√©ni f√≥r',pt:'24'},
      {en:'Twenty-five',pron:'tu√©ni f√°iv',pt:'25'},
      {en:'Twenty-six',pron:'tu√©ni siks',pt:'26'},
      {en:'Twenty-seven',pron:'tu√©ni s√©ven',pt:'27'},
      {en:'Twenty-eight',pron:'tu√©ni √©igt',pt:'28'},
      {en:'Twenty-nine',pron:'tu√©ni n√°in',pt:'29'},
      {en:'Thirty',pron:'t√†rti',pt:'30'},
      {en:'Thirty-one',pron:'t√†rti u√≥n',pt:'31'},
      {en:'Thirty-two',pron:'t√†rti ti√∫',pt:'32'},
      {en:'Thirty-three',pron:'t√†rti thrii',pt:'33'},
      {en:'Thirty-four',pron:'t√†rti f√≥r',pt:'34'},
      {en:'Thirty-five',pron:'t√†rti f√°iv',pt:'35'},
      {en:'Thirty-six',pron:'t√†rti siks',pt:'36'},
      {en:'Thirty-seven',pron:'t√†rti s√©ven',pt:'37'},
      {en:'Thirty-eight',pron:'t√†rti √©igt',pt:'38'},
      {en:'Thirty-nine',pron:'t√†rti n√°in',pt:'39'},
      {en:'Forty',pron:'f√≥rti',pt:'40'},
      {en:'Fifty',pron:'fifti',pt:'50'},
      {en:'Sixty',pron:'s√≠ksti',pt:'60'},
      {en:'Seventy',pron:'s√©venti',pt:'70'},
      {en:'Eighty',pron:'√©igti',pt:'80'},
      {en:'Ninety',pron:'n√°inti',pt:'90'},
      {en:'One hundred',pron:'u√≥n r√°ndred',pt:'100'},
      {en:'Two hundred',pron:'tch√∫ r√°ndred',pt:'200'},
      {en:'Three hundred',pron:'thrii r√°ndred',pt:'300'},
      {en:'Four hundred',pron:'f√≥r r√°ndred',pt:'400'},
      {en:'Five hundred',pron:'f√°iv r√°ndred',pt:'500'},
      {en:'Six hundred',pron:'siks r√°ndred',pt:'600'},
      {en:'Seven hundred',pron:'s√©ven r√°ndred',pt:'700'},
      {en:'Eight hundred',pron:'√©igt r√°ndred',pt:'800'},
      {en:'Nine hundred',pron:'n√°in r√°ndred',pt:'900'},
      {en:'One thousand',pron:'u√≥n th√°uzand',pt:'1.000'},
      {en:'Ten thousand',pron:'t√©n th√°uzand',pt:'10.000'},
      {en:'Twenty thousand',pron:'tu√©ni th√°uzand',pt:'20.000'},
      {en:'Thirty thousand',pron:'t√†rti th√°uzand',pt:'30.000'},
      {en:'Forty thousand',pron:'f√≥rti th√°uzand',pt:'40.000'},
      {en:'Fifty thousand',pron:'fifti th√°uzand',pt:'50.000'},
      {en:'Sixty thousand',pron:'s√≠ksti th√°uzand',pt:'60.000'},
      {en:'Seventy thousand',pron:'s√©venti th√°uzand',pt:'70.000'},
      {en:'Eighty thousand',pron:'√©igti th√°uzand',pt:'80.000'},
      {en:'Ninety thousand',pron:'n√°inti th√°uzand',pt:'90.000'},
      {en:'One hundred thousand',pron:'u√≥n r√°ndred th√°uzand',pt:'100.000'},
      {en:'Two hundred thousand',pron:'tch√∫ r√°ndred th√°uzand',pt:'200.000'},
      {en:'Three hundred thousand',pron:'thrii r√°ndred th√°uzand',pt:'300.000'},
      {en:'Four hundred thousand',pron:'f√≥r r√°ndred th√°uzand',pt:'400.000'},
      {en:'Five hundred thousand',pron:'f√°iv r√°ndred th√°uzand',pt:'500.000'},
      {en:'Six hundred thousand',pron:'siks r√°ndred th√°uzand',pt:'600.000'},
      {en:'Seven hundred thousand',pron:'s√©ven r√°ndred th√°uzand',pt:'700.000'},
      {en:'Eight hundred thousand',pron:'√©igt r√°ndred th√°uzand',pt:'800.000'},
      {en:'Nine hundred thousand',pron:'n√°in r√°ndred th√°uzand',pt:'900.000'},
      {en:'One million',pron:'u√≥n m√≠lion',pt:'1.000.000'}
    ]
  },
  {
    id: 'dias',
    name: 'Dias da Semana',
    icon: 'üìÖ',
    color: '#ffd900',
    words: [
      {en:'Sunday',pron:'s√°n-dei',pt:'Domingo'},
      {en:'Monday',pron:'m√°n-dei',pt:'Segunda-feira'},
      {en:'Tuesday',pron:'ti√∫z-dei',pt:'Ter√ßa-feira'},
      {en:'Wednesday',pron:'u√©nes-dei',pt:'Quarta-feira'},
      {en:'Thursday',pron:'t√†rz-dei',pt:'Quinta-feira'},
      {en:'Friday',pron:'fr√°i-dei',pt:'Sexta-feira'},
      {en:'Saturday',pron:'s√©-tur-dei',pt:'S√°bado'}
    ]
  },
  {
    id: 'meses',
    name: 'Meses do Ano',
    icon: 'üóìÔ∏è',
    color: '#ff9600',
    words: [
      {en:'January',pron:'gian.iu.e.ri',pt:'Janeiro'},
      {en:'February',pron:'fe.bru.e.ri',pt:'Fevereiro'},
      {en:'March',pron:'ma:tc',pt:'Mar√ßo'},
      {en:'April',pron:'ei.pril',pt:'Abril'},
      {en:'May',pron:'mei',pt:'Maio'},
      {en:'June',pron:'giun',pt:'Junho'},
      {en:'July',pron:'giu.lai',pt:'Julho'},
      {en:'August',pron:'o:.gust',pt:'Agosto'},
      {en:'September',pron:'sep.tem.ba',pt:'Setembro'},
      {en:'October',pron:'ok.tou.ba',pt:'Outubro'},
      {en:'November',pron:'nou.vem.ba',pt:'Novembro'},
      {en:'December',pron:'di.sem.ba',pt:'Dezembro'}
    ]
  },
  {
    id: 'estacoes',
    name: 'Esta√ß√µes do Ano',
    icon: 'üå∏',
    color: '#58cc02',
    words: [
      {en:'Summer',pron:'s√¢mm√¢r',pt:'Ver√£o'},
      {en:'Winter',pron:'uint√¢r',pt:'Inverno'},
      {en:'Spring',pron:'spring',pt:'Primavera'},
      {en:'Autumn',pron:'√≥t√¢m',pt:'Outono'},
      {en:'Rainy season',pron:'r√©ini s√≠s√¢n',pt:'Esta√ß√£o chuvosa'},
      {en:'Dry season',pron:'dr√°i s√≠s√¢n',pt:'Esta√ß√£o seca'},
      {en:'Hot season',pron:'h√≥t s√≠s√¢n',pt:'Esta√ß√£o quente'},
      {en:'Cold season',pron:'k√≥uld s√≠s√¢n',pt:'Esta√ß√£o fria'},
      {en:'Early spring',pron:'√°rli spring',pt:'In√≠cio da primavera'},
      {en:'Late summer',pron:'l√™it s√¢mm√¢r',pt:'Final do ver√£o'},
      {en:'Midwinter',pron:'m√≠duint√¢r',pt:'Meio do inverno'},
      {en:'Snow season',pron:'sn√¥u s√≠s√¢n',pt:'Temporada de neve'},
      {en:'Holiday season',pron:'h√≥lidei s√≠s√¢n',pt:'Temporada de f√©rias'},
      {en:'This season',pron:'dhis s√≠s√¢n',pt:'Esta esta√ß√£o'},
      {en:'Next season',pron:'n√™kst s√≠s√¢n',pt:'Pr√≥xima esta√ß√£o'}
    ]
  },
  {
    id: 'cores',
    name: 'Cores',
    icon: 'üé®',
    color: '#ff4b4b',
    words: [
      {en:'Red',pron:'r√©d',pt:'Vermelho'},
      {en:'Yellow',pron:'i√©lou',pt:'Amarelo'},
      {en:'Green',pron:'gr√≠n',pt:'Verde'},
      {en:'Dark green',pron:'darqui gr√≠n',pt:'Verde escuro'},
      {en:'Blue',pron:'bl√∫',pt:'Azul'},
      {en:'Dark blue',pron:'darqui bl√∫',pt:'Azul escuro'},
      {en:'Lilac',pron:'l√°ilac',pt:'Lil√°s'},
      {en:'Purple',pron:'p√†rpou',pt:'Roxo'},
      {en:'Pink',pron:'pink',pt:'Rosa'},
      {en:'Silver',pron:'s√≠lver',pt:'Prata'},
      {en:'Orange',pron:'√≥randj',pt:'Laranja'},
      {en:'Brown',pron:'br√°un',pt:'Marrom'},
      {en:'Beige',pron:'beije',pt:'Bege'},
      {en:'Black',pron:'bl√©kui',pt:'Preto'},
      {en:'White',pron:'u√°it',pt:'Branco'},
      {en:'Grey',pron:'grey',pt:'Cinza'},
      {en:'Turquoise',pron:'turk√≥iz',pt:'Turquesa'},
      {en:'Gold',pron:'g√¥ld',pt:'Dourado'},
      {en:'Light blue',pron:'l√¢it bl√∫',pt:'Azul claro'},
      {en:'Light green',pron:'l√¢it gr√≠n',pt:'Verde claro'}
    ]
  },
  {
    id: 'familia',
    name: 'Fam√≠lia e Amigos',
    icon: 'üë®‚Äçüë©‚Äçüëß',
    color: '#ff9600',
    words: [
      {en:'Family',pron:'f√©mili',pt:'Fam√≠lia'},
      {en:'Father',pron:'f√°-der',pt:'Pai'},
      {en:'Mother',pron:'m√°-der',pt:'M√£e'},
      {en:'Parents',pron:'p√©r-ents',pt:'Pais'},
      {en:'Son',pron:'s√¢n',pt:'Filho'},
      {en:'Daughter',pron:'d√≥-ter',pt:'Filha'},
      {en:'Children',pron:'tch√≠l-dren',pt:'Filhos/Crian√ßas'},
      {en:'Brother',pron:'br√°-der',pt:'Irm√£o'},
      {en:'Sister',pron:'s√≠s-ter',pt:'Irm√£'},
      {en:'Siblings',pron:'s√≠b-lings',pt:'Irm√£os'},
      {en:'Husband',pron:'r√°s-band',pt:'Marido'},
      {en:'Wife',pron:'u√°if',pt:'Esposa'},
      {en:'Grandfather',pron:'gr√¢nd-f√°-der',pt:'Av√¥'},
      {en:'Grandmother',pron:'gr√¢nd-m√°-der',pt:'Av√≥'},
      {en:'Grandparents',pron:'gr√¢nd-p√©r-ents',pt:'Av√≥s'},
      {en:'Uncle',pron:'√¢n-kol',pt:'Tio'},
      {en:'Aunt',pron:'√™nt',pt:'Tia'},
      {en:'Cousin',pron:'k√°-zan',pt:'Primo(a)'},
      {en:'Nephew',pron:'n√©-fiu',pt:'Sobrinho'},
      {en:'Niece',pron:'n√≠s',pt:'Sobrinha'},
      {en:'Grandson',pron:'gr√¢nd-s√¢n',pt:'Neto'},
      {en:'Granddaughter',pron:'gr√¢nd-d√≥-ter',pt:'Neta'},
      {en:'Father-in-law',pron:'f√°-der in l√≥',pt:'Sogro'},
      {en:'Mother-in-law',pron:'m√°-der in l√≥',pt:'Sogra'},
      {en:'Brother-in-law',pron:'br√°-der in l√≥',pt:'Cunhado'},
      {en:'Sister-in-law',pron:'s√≠s-ter in l√≥',pt:'Cunhada'},
      {en:'Stepfather',pron:'st√©p-f√°-der',pt:'Padrasto'},
      {en:'Stepmother',pron:'st√©p-m√°-der',pt:'Madrasta'},
      {en:'Stepson',pron:'st√©p-s√¢n',pt:'Enteado'},
      {en:'Stepdaughter',pron:'st√©p-d√≥-ter',pt:'Enteada'},
      {en:'Relative',pron:'r√©-la-tiv',pt:'Parente'},
      {en:'Child',pron:'tch√°ild',pt:'Crian√ßa/filho'},
      {en:'Baby',pron:'b√©ibi',pt:'Beb√™'},
      {en:'Friend',pron:'frend',pt:'Amigo/a'},
      {en:'Best friend',pron:'b√©st frend',pt:'Melhor amigo/a'},
      {en:'Neighbor',pron:'n√©ib√¢r',pt:'Vizinho/a'}
    ]
  },
  {
    id: 'objetos',
    name: 'Objetos do Dia a Dia',
    icon: 'üéí',
    color: '#1cb0f6',
    words: [
      {en:'Backpack',pron:'b√°kpak',pt:'Mochila'},
      {en:'Pencil',pron:'p√©nsil',pt:'L√°pis'},
      {en:'Pen',pron:'p√©n',pt:'Caneta'},
      {en:'Book',pron:'b√∫k',pt:'Livro'},
      {en:'Notebook',pron:'n√≥tbuk',pt:'Caderno'},
      {en:'Eraser',pron:'ir√©iz√¢r',pt:'Borracha'},
      {en:'Scissors',pron:'s√≠z√¢rs',pt:'Tesoura'},
      {en:'Ruler',pron:'r√∫l√¢r',pt:'R√©gua'},
      {en:'Keys',pron:'k√≠iz',pt:'Chaves'},
      {en:'Wallet',pron:'u√≥lit',pt:'Carteira'},
      {en:'Phone',pron:'f√≥un',pt:'Celular'},
      {en:'Computer',pron:'komp√≠ut√¢r',pt:'Computador'},
      {en:'Umbrella',pron:'√¢mbr√©la',pt:'Guarda-chuva'},
      {en:'Watch',pron:'u√≥tch',pt:'Rel√≥gio'},
      {en:'Glasses',pron:'gl√°siz',pt:'√ìculos'},
      {en:'Bag',pron:'b√°g',pt:'Bolsa'},
      {en:'Bottle',pron:'b√≥tol',pt:'Garrafa'},
      {en:'Chair',pron:'tch√©r',pt:'Cadeira'},
      {en:'Table',pron:'t√©ibol',pt:'Mesa'},
      {en:'Door',pron:'d√≥r',pt:'Porta'},
      {en:'Window',pron:'u√≠ndou',pt:'Janela'},
      {en:'Lamp',pron:'l√°mp',pt:'L√¢mpada'},
      {en:'Clock',pron:'kl√≥k',pt:'Rel√≥gio (parede)'},
      {en:'Mirror',pron:'m√≠r√¢r',pt:'Espelho'},
      {en:'Towel',pron:'t√°uel',pt:'Toalha'}
    ]
  },
  {
    id: 'corpo',
    name: 'Partes do Corpo',
    icon: 'ü´Ä',
    color: '#ff4b4b',
    words: [
      {en:'Head',pron:'h√©d',pt:'Cabe√ßa'},
      {en:'Hair',pron:'h√©r',pt:'Cabelo'},
      {en:'Face',pron:'f√©is',pt:'Rosto'},
      {en:'Eyes',pron:'√°iz',pt:'Olhos'},
      {en:'Ear',pron:'√≠r',pt:'Orelha'},
      {en:'Nose',pron:'n√≥uz',pt:'Nariz'},
      {en:'Mouth',pron:'m√°uth',pt:'Boca'},
      {en:'Teeth',pron:'t√≠th',pt:'Dentes'},
      {en:'Tongue',pron:'t√¢ng',pt:'L√≠ngua'},
      {en:'Neck',pron:'n√©k',pt:'Pesco√ßo'},
      {en:'Shoulder',pron:'sh√≥uld√¢r',pt:'Ombro'},
      {en:'Arm',pron:'√°rm',pt:'Bra√ßo'},
      {en:'Elbow',pron:'√©lbou',pt:'Cotovelo'},
      {en:'Hand',pron:'h√°nd',pt:'M√£o'},
      {en:'Finger',pron:'f√≠ng√¢r',pt:'Dedo (m√£o)'},
      {en:'Nail',pron:'n√©il',pt:'Unha'},
      {en:'Chest',pron:'tch√©st',pt:'Peito'},
      {en:'Back',pron:'b√°k',pt:'Costas'},
      {en:'Stomach',pron:'st√¢m√¢k',pt:'Est√¥mago/Barriga'},
      {en:'Leg',pron:'l√©g',pt:'Perna'},
      {en:'Knee',pron:'n√≠:',pt:'Joelho'},
      {en:'Foot',pron:'f√∫t',pt:'P√©'},
      {en:'Toe',pron:'t√≥u',pt:'Dedo (p√©)'},
      {en:'Heart',pron:'h√°rt',pt:'Cora√ß√£o'},
      {en:'Spine',pron:'sp√°in',pt:'Coluna'}
    ]
  },
  {
    id: 'casa',
    name: 'C√¥modos da Casa e Mob√≠lia',
    icon: 'üè†',
    color: '#58cc02',
    words: [
      {en:'House',pron:'h√°us',pt:'Casa'},
      {en:'Apartment',pron:'ap√°rtment',pt:'Apartamento'},
      {en:'Living room',pron:'l√≠ving r√∫m',pt:'Sala de estar'},
      {en:'Bedroom',pron:'b√©dr√∫m',pt:'Quarto'},
      {en:'Bathroom',pron:'b√°thrum',pt:'Banheiro'},
      {en:'Kitchen',pron:'k√≠tchen',pt:'Cozinha'},
      {en:'Dining room',pron:'d√°ining r√∫m',pt:'Sala de jantar'},
      {en:'Garage',pron:'gar√°dj',pt:'Garagem'},
      {en:'Garden',pron:'g√°rden',pt:'Jardim'},
      {en:'Balcony',pron:'b√°lkoni',pt:'Varanda'},
      {en:'Stairs',pron:'st√©rs',pt:'Escadas'},
      {en:'Hallway',pron:'h√≥lwei',pt:'Corredor'},
      {en:'Sofa',pron:'s√≥fa',pt:'Sof√°'},
      {en:'Armchair',pron:'√°rmtch√©r',pt:'Poltrona'},
      {en:'Bed',pron:'b√©d',pt:'Cama'},
      {en:'Wardrobe',pron:'u√≥rdrob',pt:'Guarda-roupa'},
      {en:'Shelf',pron:'sh√©lf',pt:'Prateleira'},
      {en:'Refrigerator',pron:'rifr√≠jer√¢tor',pt:'Geladeira'},
      {en:'Stove',pron:'st√≥uv',pt:'Fog√£o'},
      {en:'Microwave',pron:'m√°ikrouweiv',pt:'Micro-ondas'},
      {en:'Sink',pron:'s√≠ngk',pt:'Pia'},
      {en:'Bathtub',pron:'b√°thth√¢b',pt:'Banheira'},
      {en:'Shower',pron:'sh√°u√¢r',pt:'Chuveiro'},
      {en:'Toilet',pron:'t√≥ilit',pt:'Vaso sanit√°rio'},
      {en:'Curtain',pron:'k√©rtin',pt:'Cortina'},
      {en:'Rug',pron:'r√¢g',pt:'Tapete'},
      {en:'Pillow',pron:'p√≠lou',pt:'Travesseiro'},
      {en:'Blanket',pron:'bl√°engkit',pt:'Cobertor'}
    ]
  }
];

// =====================================================
// ============= GAME STATE ===========================
// =====================================================
let state = {
  lives: 5, maxLives: 5,
  xp: 0, level: 1,
  streak: 0, maxStreak: 0,
  totalAnswered: 0, totalCorrect: 0,
  sessionXp: 0,
  unlockedAchievements: [],
  catStats: {}, // per category correct count
  selectedCats: [],
  currentMode: 'choice',
  currentQuestion: null,
  questionCount: 0,
  answered: false,
  selectedChoiceValue: null,
  matchState: null,
  wordArrangeState: null,
};

function xpForLevel(lvl) { return lvl * 100; }

function loadState() {
  try {
    const s = JSON.parse(localStorage.getItem('vocabquest_v1') || '{}');
    state.xp = s.xp || 0;
    state.level = s.level || 1;
    state.maxStreak = s.maxStreak || 0;
    state.totalAnswered = s.totalAnswered || 0;
    state.totalCorrect = s.totalCorrect || 0;
    state.unlockedAchievements = s.unlockedAchievements || [];
    state.catStats = s.catStats || {};
  } catch(e) {}
}

function saveState() {
  localStorage.setItem('vocabquest_v1', JSON.stringify({
    xp: state.xp, level: state.level, maxStreak: state.maxStreak,
    totalAnswered: state.totalAnswered, totalCorrect: state.totalCorrect,
    unlockedAchievements: state.unlockedAchievements, catStats: state.catStats,
  }));
}

// =====================================================
// ============= QUESTION GENERATOR ===================
// =====================================================

function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function shuffleArray(arr) {
  const a = [...arr];
  for (let i = a.length-1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}

function getActiveWords() {
  let words = [];
  state.selectedCats.forEach(catId => {
    const cat = CATEGORIES.find(c => c.id === catId);
    if (cat) words.push(...cat.words.map(w => ({...w, catId, catName: cat.name, catIcon: cat.icon, catColor: cat.color})));
  });
  return words;
}

function generateQuestion() {
  const pool = getActiveWords();
  if (pool.length < 4) return null;

  const word = rand(pool);
  let mode = state.currentMode;
  if (mode === 'mix') {
    // Alfabeto is better for fill/choice, match needs >= 4 words from same cat
    const catWords = pool.filter(w => w.catId === word.catId);
    const opts = ['choice', 'fill'];
    if (catWords.length >= 6) opts.push('match');
    mode = rand(opts);
  }

  if (mode === 'match') {
    return generateMatchQuestion(pool, word);
  }

  // Decide direction: EN‚ÜíPT or PT‚ÜíEN (50/50)
  const direction = Math.random() > 0.5 ? 'en_to_pt' : 'pt_to_en';

  if (mode === 'choice') {
    return generateChoiceQuestion(pool, word, direction);
  } else {
    return generateFillQuestion(word, direction);
  }
}

function generateChoiceQuestion(pool, word, direction) {
  // Special handling for alphabet: question = letter, answers = pronunciations
  if (word.catId === 'alfabeto') {
    return generateAlphabetQuestion(pool, word);
  }

  // Build distractors from same category or other words
  const distractors = pool.filter(w => w.en !== word.en);
  const shuffledD = shuffleArray(distractors).slice(0, 3);

  let correct, choices;
  let instruction, displayWord, displayPron;

  if (direction === 'en_to_pt') {
    correct = word.pt;
    instruction = `Qual o significado de <strong>"${word.en}"</strong>?`;
    displayWord = word.en;
    displayPron = word.pron;
    choices = shuffleArray([correct, ...shuffledD.map(d => d.pt)]);
  } else {
    correct = word.en;
    instruction = `Como se diz <strong>"${word.pt}"</strong> em ingl√™s?`;
    displayWord = word.pt;
    displayPron = null;
    choices = shuffleArray([correct, ...shuffledD.map(d => d.en)]);
  }

  return {
    id: Math.random(), type: 'choice', direction,
    word, instruction, displayWord, displayPron,
    correct, choices,
    catName: word.catName, catIcon: word.catIcon, catColor: word.catColor, catId: word.catId,
  };
}

// Alphabet-specific question: show letter, pick pronunciation
// Distractors are visually/phonetically similar letters
const ALPHA_SIMILAR = {
  'A': ['EI','AI','OU','I'],
  'B': ['BI','PI','DI','VI'],
  'C': ['CI','SI','DJI','TI'],
  'D': ['DI','BI','TI','DJI'],
  'E': ['I','AI','EI','IU'],
  'F': ['√âF','√âCS','ES','EL'],
  'G': ['DJI','DI','DJEI','CI'],
  'H': ['EITCH','AI','EI','I'],
  'I': ['AI','EI','I','IU'],
  'J': ['DJEI','DJI','DI','DJEI'],
  'K': ['KEI','EI','DI','CI'],
  'L': ['EL','EM','EN','AR'],
  'M': ['EM','EN','EL','√âF'],
  'N': ['EN','EM','EL','IN'],
  'O': ['OU','IU','EI','AU'],
  'P': ['PI','BI','DI','TI'],
  'Q': ['QUIU','IU','CI','KEI'],
  'R': ['AR','√âF','EL','ES'],
  'S': ['ES','√âCS','√âF','EL'],
  'T': ['TI','DI','BI','CI'],
  'U': ['IU','OU','AI','EI'],
  'V': ['VI','BI','PI','DI'],
  'W': ['D√ÇBLIU','VI','IU','UAI'],
  'X': ['√âCS','ES','√âF','EL'],
  'Y': ['UAI','AI','EI','IU'],
  'Z': ['ZI','DI','ES','CI'],
};

function generateAlphabetQuestion(pool, word) {
  const correct = word.pt; // the pronunciation sound e.g. "EI"
  const letter = word.en;  // e.g. "A"

  // Get phonetically similar distractors
  const similar = (ALPHA_SIMILAR[letter] || []).filter(s => s !== correct);
  // Shuffle and pick 3 distractors
  const distractors = shuffleArray(similar).slice(0, 3);
  // Pad with random pronunciation sounds if needed
  if (distractors.length < 3) {
    const allSounds = pool.filter(w => w.en !== letter).map(w => w.pt);
    const extra = shuffleArray(allSounds).filter(s => !distractors.includes(s) && s !== correct);
    while (distractors.length < 3 && extra.length) distractors.push(extra.shift());
  }

  const choices = shuffleArray([correct, ...distractors.slice(0, 3)]);

  return {
    id: Math.random(),
    type: 'choice',
    direction: 'en_to_pt',
    word,
    instruction: `Como se pronuncia a letra <strong>${letter}</strong> em ingl√™s?`,
    displayWord: letter,
    displayPron: null,
    correct,
    choices,
    catName: word.catName, catIcon: word.catIcon, catColor: word.catColor, catId: word.catId,
    isAlphabet: true,
  };
}

function generateFillQuestion(word, direction) {
  let instruction, displayWord, displayPron, correct, hint;

  // Special: alphabet fill ‚Äî show letter, type pronunciation
  if (word.catId === 'alfabeto') {
    instruction = `Como se pronuncia a letra <strong>${word.en}</strong> em ingl√™s?`;
    displayWord = word.en;
    displayPron = null;
    correct = word.pt; // pronunciation sound e.g. "EI"
    hint = word.pt[0].toLowerCase();
    return {
      id: Math.random(), type: 'fill', direction: 'en_to_pt',
      word, instruction, displayWord, displayPron,
      correct, hint,
      catName: word.catName, catIcon: word.catIcon, catColor: word.catColor, catId: word.catId,
    };
  }

  if (direction === 'en_to_pt') {
    instruction = `Traduza para portugu√™s: <strong>${word.en}</strong>`;
    displayWord = word.en;
    displayPron = word.pron;
    correct = word.pt;
    hint = word.pt[0].toLowerCase();
  } else {
    instruction = `Como se escreve em ingl√™s: <strong>${word.pt}</strong>`;
    displayWord = word.pt;
    displayPron = null;
    correct = word.en;
    hint = word.en[0].toLowerCase();
  }

  return {
    id: Math.random(), type: 'fill', direction,
    word, instruction, displayWord, displayPron,
    correct, hint,
    catName: word.catName, catIcon: word.catIcon, catColor: word.catColor, catId: word.catId,
  };
}

function generateMatchQuestion(pool, anchorWord) {
  // Pick 4-5 words from same or mixed categories
  const samecat = pool.filter(w => w.catId === anchorWord.catId);
  const source = samecat.length >= 4 ? samecat : pool;
  const selected = shuffleArray(source).slice(0, Math.min(5, source.length));

  return {
    id: Math.random(), type: 'match',
    word: anchorWord,
    matchWords: selected,
    catName: anchorWord.catName, catIcon: anchorWord.catIcon, catColor: anchorWord.catColor, catId: anchorWord.catId,
    instruction: 'Combine cada palavra inglesa com sua tradu√ß√£o em portugu√™s:',
  };
}

// =====================================================
// ============= RENDERING ============================
// =====================================================

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function renderCategoryList() {
  const grid = document.getElementById('categories-grid');
  grid.innerHTML = CATEGORIES.map(cat => {
    const count = cat.words.length;
    return `
      <div class="category-card" id="cat-${cat.id}" data-id="${cat.id}">
        <span class="cat-icon" style="cursor:pointer" onclick="openStudyScreen('${cat.id}')">${cat.icon}</span>
        <div class="cat-info" style="cursor:pointer" onclick="openStudyScreen('${cat.id}')">
          <div class="cat-name">${cat.name}</div>
          <div class="cat-count" id="cat-sub-${cat.id}">${count} palavras &bull; <span style="color:var(--accent4)">ver vocabul√°rio ‚Üí</span></div>
        </div>
        <span id="cat-check-${cat.id}" style="font-size:22px;cursor:pointer;min-width:28px;text-align:center;" onclick="toggleCat('${cat.id}');event.stopPropagation();">‚òê</span>
      </div>
    `;
  }).join('');
}

function toggleCat(id) {
  const idx = state.selectedCats.indexOf(id);
  if (idx >= 0) state.selectedCats.splice(idx, 1);
  else state.selectedCats.push(id);

  const selected = state.selectedCats.includes(id);
  document.getElementById(`cat-${id}`).classList.toggle('selected', selected);
  const chk = document.getElementById(`cat-check-${id}`);
  if (chk) chk.textContent = selected ? '‚úÖ' : '‚òê';
  document.getElementById('btn-start').disabled = state.selectedCats.length === 0;
}

function selectAllCats() {
  state.selectedCats = CATEGORIES.map(c => c.id);
  CATEGORIES.forEach(c => {
    document.getElementById(`cat-${c.id}`)?.classList.add('selected');
    const chk = document.getElementById(`cat-check-${c.id}`);
    if (chk) chk.textContent = '‚úÖ';
  });
  document.getElementById('btn-start').disabled = false;
}

function deselectAllCats() {
  state.selectedCats = [];
  CATEGORIES.forEach(c => {
    document.getElementById(`cat-${c.id}`)?.classList.remove('selected');
    const chk = document.getElementById(`cat-check-${c.id}`);
    if (chk) chk.textContent = '‚òê';
  });
  document.getElementById('btn-start').disabled = true;
}

function startGame() {
  if (state.selectedCats.length === 0) return;
  state.lives = state.maxLives;
  state.streak = 0;
  state.sessionXp = 0;
  state.questionCount = 0;
  state.answered = false;
  state.selectedChoiceValue = null;
  updateHUD();
  showScreen('game-screen');
  renderNextQuestion();
}

function renderNextQuestion() {
  state.answered = false;
  state.selectedChoiceValue = null;
  state.matchState = null;
  state.wordArrangeState = null;
  state.currentQuestion = generateQuestion();
  state.questionCount++;

  const q = state.currentQuestion;
  if (!q) { showScreen('home-screen'); return; }

  const container = document.getElementById('question-container');
  const feedbackEl = document.getElementById('feedback-container');
  feedbackEl.style.display = 'none';
  feedbackEl.innerHTML = '';

  // Progress
  document.getElementById('progress-fill').style.width = Math.min(state.questionCount / 20 * 100, 100) + '%';

  let html = `
    <div class="question-card">
      <div class="cat-tag" style="color:${q.catColor};border-color:${q.catColor}33;background:${q.catColor}18;">
        ${q.catIcon} ${q.catName}
      </div>
      <div class="q-instruction">${q.instruction}</div>
  `;

  if (q.type === 'choice') html += renderChoice(q);
  else if (q.type === 'fill') html += renderFill(q);
  else if (q.type === 'match') html += renderMatch(q);

  html += `</div>`;
  container.innerHTML = html;

  // Footer buttons
  const btnCheck = document.getElementById('btn-check');
  const btnNext = document.getElementById('btn-next');
  btnNext.style.display = 'none';
  btnCheck.style.display = 'block';
  btnCheck.disabled = true;
  btnCheck.textContent = 'VERIFICAR';

  if (q.type === 'fill') {
    const inp = document.getElementById('fill-input');
    if (inp) {
      inp.focus();
      inp.addEventListener('input', () => { btnCheck.disabled = inp.value.trim().length === 0; });
      inp.addEventListener('keydown', e => { if (e.key === 'Enter' && !btnCheck.disabled && !state.answered) checkAnswer(); });
    }
  }

  if (q.type === 'match') {
    // Match handles its own check
    btnCheck.style.display = 'none';
    btnNext.style.display = 'none';
    // init match state
    state.matchState = {
      words: q.matchWords,
      selectedEN: null,
      matchedPairs: [],
      mistakes: 0,
    };
  }
}

function renderChoice(q) {
  const wordDisplay = q.direction === 'en_to_pt'
    ? `<div class="word-main">${q.displayWord}</div>${q.displayPron ? `<div class="word-pron">${q.displayPron}</div>` : ''}`
    : `<div class="word-main-pt">${q.displayWord}</div>`;

  const btns = q.choices.map(c => `
    <button class="choice-btn" onclick="selectChoice(this,'${escHtml(c)}')" data-value="${escHtml(c)}">${escHtml(c)}</button>
  `).join('');

  return `<div class="word-display">${wordDisplay}</div><div class="choices-grid">${btns}</div>`;
}

function renderFill(q) {
  const wordDisplay = q.direction === 'en_to_pt'
    ? `<div class="word-main">${q.displayWord}</div>${q.displayPron ? `<div class="word-pron">${q.displayPron}</div>` : ''}`
    : `<div class="word-main-pt">${q.displayWord}</div>`;

  return `
    <div class="word-display">${wordDisplay}</div>
    <input class="blank-input" id="fill-input" type="text" placeholder="Digite a tradu√ß√£o..." autocomplete="off" autocorrect="off" spellcheck="false">
  `;
}

function renderMatch(q) {
  const words = q.matchWords;
  const enItems = shuffleArray([...words]).map(w =>
    `<div class="match-item" id="men-${escHtml(w.en)}" onclick="selectMatchEN('${escHtml(w.en)}')" data-en="${escHtml(w.en)}">${escHtml(w.en)}</div>`
  ).join('');
  const ptItems = shuffleArray([...words]).map(w =>
    `<div class="match-item" id="mpt-${escHtml(w.en)}" onclick="selectMatchPT('${escHtml(w.en)}')" data-en="${escHtml(w.en)}">${escHtml(w.pt)}</div>`
  ).join('');

  return `
    <div style="font-size:13px;color:var(--text3);font-weight:600;margin-bottom:10px;text-align:center;">Clique em ingl√™s, depois em portugu√™s</div>
    <div class="match-grid">
      <div class="match-col">${enItems}</div>
      <div class="match-col">${ptItems}</div>
    </div>
  `;
}

// =====================================================
// ============= INTERACTIONS =========================
// =====================================================

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function selectChoice(btn, value) {
  if (state.answered) return;
  state.selectedChoiceValue = value;
  document.querySelectorAll('.choice-btn').forEach(b => {
    b.style.borderColor = '';
    b.style.background = '';
  });
  btn.style.borderColor = 'var(--accent4)';
  btn.style.background = 'rgba(28,176,246,0.15)';
  document.getElementById('btn-check').disabled = false;
}

// Match logic
function selectMatchEN(en) {
  if (!state.matchState || state.answered) return;
  const ms = state.matchState;
  if (ms.matchedPairs.some(p => p.en === en)) return;

  // Deselect previous
  document.querySelectorAll('.match-item').forEach(el => {
    if (!el.classList.contains('matched')) el.classList.remove('selected-a');
  });

  ms.selectedEN = en;
  const el = document.getElementById(`men-${en}`);
  if (el) el.classList.add('selected-a');
}

function selectMatchPT(enKey) {
  if (!state.matchState || state.answered) return;
  const ms = state.matchState;
  if (!ms.selectedEN) return;
  if (ms.matchedPairs.some(p => p.en === enKey || p.en === ms.selectedEN)) return;

  const isCorrect = ms.selectedEN === enKey;

  if (isCorrect) {
    const enEl = document.getElementById(`men-${ms.selectedEN}`);
    const ptEl = document.getElementById(`mpt-${enKey}`);
    if (enEl) { enEl.classList.remove('selected-a'); enEl.classList.add('matched'); }
    if (ptEl) ptEl.classList.add('matched');

    ms.matchedPairs.push({ en: ms.selectedEN });
    ms.selectedEN = null;

    // Check if all matched
    if (ms.matchedPairs.length === ms.words.length) {
      // Success
      const xpGain = 15 + ms.words.length * 3;
      state.streak += ms.words.length;
      if (state.streak > state.maxStreak) state.maxStreak = state.streak;
      state.totalCorrect += ms.words.length;
      state.totalAnswered += ms.words.length;
      state.xp += xpGain;
      state.sessionXp += xpGain;
      checkLevelUp();
      checkAchievements();
      updateHUD();
      saveState();
      playStreakSound();
      showXpPopup(`+${xpGain} XP`);
      showToast('üéâ Todos os pares encontrados!');
      setTimeout(() => {
        document.getElementById('btn-next').style.display = 'block';
      }, 600);
    }
  } else {
    ms.mistakes++;
    state.streak = 0;
    state.lives--;
    playWrongSound();
    updateHUD();

    const ptEl = document.getElementById(`mpt-${enKey}`);
    const enEl = document.getElementById(`men-${ms.selectedEN}`);
    if (ptEl) { ptEl.classList.add('wrong-match'); setTimeout(() => ptEl.classList.remove('wrong-match'), 350); }
    if (enEl) { enEl.classList.remove('selected-a'); enEl.classList.add('wrong-match'); setTimeout(() => enEl.classList.remove('wrong-match'), 350); }
    ms.selectedEN = null;

    if (state.lives <= 0) setTimeout(showGameOver, 1000);
  }
}

// =====================================================
// ============= ANSWER CHECKING ======================
// =====================================================

function checkAnswer() {
  if (state.answered) return;
  state.answered = true;
  const q = state.currentQuestion;

  let userAnswer = '';
  if (q.type === 'choice') userAnswer = state.selectedChoiceValue || '';
  else if (q.type === 'fill') userAnswer = document.getElementById('fill-input')?.value.trim() || '';

  const normalize = s => s.toLowerCase().trim().replace(/[√°√†√£√¢√§]/g,'a').replace(/[√©√®√™]/g,'e').replace(/[√≠√¨√Æ]/g,'i').replace(/[√≥√≤√µ√¥]/g,'o').replace(/[√∫√π√ª]/g,'u').replace(/[√ß]/g,'c').replace(/[√±]/g,'n');
  const isCorrect = normalize(userAnswer) === normalize(q.correct);

  // Update cat stats
  if (!state.catStats[q.catId]) state.catStats[q.catId] = { correct: 0, total: 0 };
  state.catStats[q.catId].total++;

  state.totalAnswered++;

  if (isCorrect) {
    state.totalCorrect++;
    state.catStats[q.catId].correct++;
    state.streak++;
    if (state.streak > state.maxStreak) state.maxStreak = state.streak;
    const xpGain = 10 + Math.min(state.streak * 2, 20);
    state.xp += xpGain;
    state.sessionXp += xpGain;
    checkLevelUp();
    if (state.streak === 5 || state.streak % 10 === 0) { playStreakSound(); showStreakMilestone(); }
    else { playCorrectSound(); }
    showXpPopup(`+${xpGain} XP`);
    showFeedback(true, q, userAnswer);
    if (q.type === 'fill') document.getElementById('fill-input')?.classList.add('correct');
    if (q.type === 'choice') {
      document.querySelectorAll('.choice-btn').forEach(b => {
        b.disabled = true;
        if (b.dataset.value === q.correct) b.classList.add('correct-choice');
        else { b.style.borderColor = ''; b.style.background = ''; }
      });
    }
  } else {
    state.streak = 0;
    state.lives--;
    playWrongSound();
    showFeedback(false, q, userAnswer);
    if (q.type === 'fill') document.getElementById('fill-input')?.classList.add('wrong');
    if (q.type === 'choice') {
      document.querySelectorAll('.choice-btn').forEach(b => {
        b.disabled = true;
        if (b.dataset.value === q.correct) b.classList.add('correct-choice');
        else if (b.style.background) b.classList.add('wrong-choice');
      });
    }
    if (state.lives <= 0) setTimeout(showGameOver, 2000);
  }

  checkAchievements();
  updateHUD();
  saveState();

  document.getElementById('btn-check').style.display = 'none';
  document.getElementById('btn-next').style.display = 'block';
}

const MOTIVATIONAL = [
  "Incr√≠vel! Continue assim! üöÄ","Voc√™ est√° arrasando! üî•","Perfeito! ‚≠ê","Fant√°stico! üí™",
  "Excelente! üèÜ","Keep going! üéØ","Brilhante! ‚ú®","You're doing great! üåü"
];
const WRONG_REACTIONS = [
  "N√£o desista! üíô","Erro faz parte! üìö","Quase l√°! üîÑ","Revise e tente! ‚úä"
];

function showFeedback(correct, q, userAnswer) {
  const container = document.getElementById('feedback-container');
  container.style.display = 'block';

  const motivation = correct ? rand(MOTIVATIONAL) : rand(WRONG_REACTIONS);

  let html;
  if (correct) {
    html = `
      <div class="feedback-panel correct-panel">
        <div class="feedback-header"><span class="feedback-icon">üéâ</span><span class="feedback-title">Correto!</span></div>
        <div class="feedback-info">
          <strong>${q.word.en}</strong> = <strong>${q.word.pt}</strong>
          ${q.word.pron ? `<div class="feedback-pron">üîä /${q.word.pron}/</div>` : ''}
        </div>
        <div class="feedback-motivation">${motivation}</div>
      </div>
    `;
  } else {
    html = `
      <div class="feedback-panel wrong-panel">
        <div class="feedback-header"><span class="feedback-icon">‚ùå</span><span class="feedback-title">Incorreto</span></div>
        <div class="feedback-info">Sua resposta: <span style="color:var(--accent3);font-family:'Space Mono',monospace;font-weight:700;">${escHtml(userAnswer || '(vazio)')}</span></div>
        <div class="feedback-correct-answer">‚úÖ Resposta correta: ${escHtml(q.correct)}</div>
        <div class="feedback-info">
          <strong>${q.word.en}</strong> = <strong>${q.word.pt}</strong>
          ${q.word.pron ? `<div class="feedback-pron">üîä /${q.word.pron}/</div>` : ''}
          <div style="margin-top:6px;font-size:12px;color:var(--text3);">üìÇ Categoria: ${q.catIcon} ${q.catName}</div>
        </div>
        <div class="feedback-motivation" style="color:var(--accent4);">${motivation}</div>
      </div>
    `;
  }

  container.innerHTML = html;
  container.scrollIntoView({ behavior:'smooth', block:'nearest' });
}

function nextQuestion() {
  if (state.lives <= 0) { showGameOver(); return; }
  renderNextQuestion();
  document.getElementById('question-container').scrollIntoView({ behavior:'smooth', block:'start' });
}

function showGameOver() {
  document.getElementById('go-total').textContent = state.totalAnswered;
  document.getElementById('go-correct').textContent = state.totalCorrect;
  document.getElementById('go-xp').textContent = state.sessionXp;
  document.getElementById('go-streak').textContent = state.maxStreak;
  showScreen('gameover-screen');
}

// ===== HUD =====
function updateHUD() {
  const livesEl = document.getElementById('hud-lives');
  if (livesEl) {
    livesEl.innerHTML = '';
    for (let i = 0; i < state.maxLives; i++) {
      const h = document.createElement('span');
      h.className = 'life-icon' + (i < state.lives ? '' : ' lost');
      h.textContent = '‚ù§Ô∏è';
      livesEl.appendChild(h);
    }
  }
  const sc = document.getElementById('streak-count');
  if (sc) sc.textContent = state.streak;

  const xpNeeded = xpForLevel(state.level);
  const pct = Math.min((state.xp / xpNeeded) * 100, 100);
  const xpBar = document.getElementById('xp-bar');
  if (xpBar) xpBar.style.width = pct + '%';
  const xpLabel = document.getElementById('xp-label');
  if (xpLabel) xpLabel.textContent = `XP: ${state.xp}/${xpNeeded}`;
  const hudLevel = document.getElementById('hud-level');
  if (hudLevel) hudLevel.textContent = `Lv.${state.level}`;

  // Home
  const hl = document.getElementById('home-level');
  if (hl) hl.textContent = state.level;
  const hx = document.getElementById('home-xp');
  if (hx) hx.textContent = state.xp + (state.level-1)*100;
  const hs = document.getElementById('home-streak');
  if (hs) hs.textContent = state.maxStreak;
}

function checkLevelUp() {
  while (state.xp >= xpForLevel(state.level)) {
    state.xp -= xpForLevel(state.level);
    state.level++;
    showToast(`üéâ N√≠vel ${state.level} alcan√ßado!`);
  }
}

// =====================================================
// ============= AUDIO ENGINE =========================
// =====================================================

let audioCtx = null;

function getAudioCtx() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  // Resume if suspended (mobile browsers require user gesture)
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

function playCorrectSound() {
  try {
    const ctx = getAudioCtx();
    const now = ctx.currentTime;

    // Cheerful ascending chime: C5 ‚Üí E5 ‚Üí G5 ‚Üí C6
    const notes = [523.25, 659.25, 783.99, 1046.50];
    const delays = [0, 0.08, 0.16, 0.26];

    notes.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.connect(gain);
      gain.connect(ctx.destination);

      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, now + delays[i]);

      // Last note rings longer
      const duration = i === notes.length - 1 ? 0.35 : 0.18;
      gain.gain.setValueAtTime(0, now + delays[i]);
      gain.gain.linearRampToValueAtTime(0.28, now + delays[i] + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.001, now + delays[i] + duration);

      osc.start(now + delays[i]);
      osc.stop(now + delays[i] + duration + 0.05);
    });

    // Add a soft sparkle layer on the last note
    const sparkle = ctx.createOscillator();
    const sparkleGain = ctx.createGain();
    sparkle.connect(sparkleGain);
    sparkleGain.connect(ctx.destination);
    sparkle.type = 'triangle';
    sparkle.frequency.setValueAtTime(2093, now + 0.26);
    sparkleGain.gain.setValueAtTime(0, now + 0.26);
    sparkleGain.gain.linearRampToValueAtTime(0.12, now + 0.28);
    sparkleGain.gain.exponentialRampToValueAtTime(0.001, now + 0.55);
    sparkle.start(now + 0.26);
    sparkle.stop(now + 0.6);

  } catch(e) { /* audio not supported */ }
}

function playWrongSound() {
  try {
    const ctx = getAudioCtx();
    const now = ctx.currentTime;

    // Low "doh-doh" descending buzz
    const notes = [220, 185];
    const delays = [0, 0.18];

    notes.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      // Add slight distortion via waveshaper
      const wave = ctx.createWaveShaper();
      function makeDistortionCurve(amount) {
        const samples = 256;
        const curve = new Float32Array(samples);
        for (let j = 0; j < samples; j++) {
          const x = (j * 2) / samples - 1;
          curve[j] = ((Math.PI + amount) * x) / (Math.PI + amount * Math.abs(x));
        }
        return curve;
      }
      wave.curve = makeDistortionCurve(30);

      osc.connect(wave);
      wave.connect(gain);
      gain.connect(ctx.destination);

      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(freq, now + delays[i]);
      osc.frequency.linearRampToValueAtTime(freq * 0.88, now + delays[i] + 0.22);

      gain.gain.setValueAtTime(0, now + delays[i]);
      gain.gain.linearRampToValueAtTime(0.22, now + delays[i] + 0.03);
      gain.gain.exponentialRampToValueAtTime(0.001, now + delays[i] + 0.28);

      osc.start(now + delays[i]);
      osc.stop(now + delays[i] + 0.35);
    });

  } catch(e) { /* audio not supported */ }
}

function playStreakSound() {
  try {
    const ctx = getAudioCtx();
    const now = ctx.currentTime;
    // Extra sparkly ascending run for streak milestone
    const notes = [523.25, 659.25, 783.99, 1046.50, 1318.51, 1567.98];
    notes.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.type = i % 2 === 0 ? 'sine' : 'triangle';
      osc.frequency.setValueAtTime(freq, now + i * 0.07);
      gain.gain.setValueAtTime(0, now + i * 0.07);
      gain.gain.linearRampToValueAtTime(0.22, now + i * 0.07 + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.07 + 0.25);
      osc.start(now + i * 0.07);
      osc.stop(now + i * 0.07 + 0.3);
    });
  } catch(e) {}
}

function showXpPopup(text) {
  const el = document.createElement('div');
  el.className = 'xp-popup';
  el.textContent = text;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1600);
}

function showStreakMilestone() {
  const el = document.createElement('div');
  el.className = 'streak-milestone';
  el.innerHTML = `üî•<br>${state.streak}x Combo!`;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1600);
}

function showToast(msg) {
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2600);
}

// ===== ACHIEVEMENTS =====
const ACHIEV = [
  { id:'first', icon:'üåü', name:'Primeira Palavra', cond:() => state.totalCorrect >= 1 },
  { id:'10words', icon:'üìñ', name:'10 Palavras', cond:() => state.totalCorrect >= 10 },
  { id:'50words', icon:'üìö', name:'50 Palavras', cond:() => state.totalCorrect >= 50 },
  { id:'100words', icon:'üéì', name:'100 Palavras', cond:() => state.totalCorrect >= 100 },
  { id:'streak5', icon:'üî•', name:'5 Seguidos', cond:() => state.maxStreak >= 5 },
  { id:'streak10', icon:'üí•', name:'10 Combo', cond:() => state.maxStreak >= 10 },
  { id:'level5', icon:'‚¨ÜÔ∏è', name:'N√≠vel 5', cond:() => state.level >= 5 },
  { id:'level10', icon:'üèÜ', name:'N√≠vel 10', cond:() => state.level >= 10 },
  { id:'allcats', icon:'üóÇÔ∏è', name:'Todas Categorias', cond:() => Object.keys(state.catStats).length >= CATEGORIES.length },
  { id:'accuracy', icon:'üéØ', name:'Precis√£o 90%', cond:() => state.totalAnswered >= 20 && (state.totalCorrect/state.totalAnswered) >= 0.9 },
];

function checkAchievements() {
  ACHIEV.forEach(a => {
    if (!state.unlockedAchievements.includes(a.id) && a.cond()) {
      state.unlockedAchievements.push(a.id);
      showToast(`üèÖ Conquista: ${a.name}!`);
    }
  });
}

// ===== STATS =====
function renderStats() {
  const accuracy = state.totalAnswered > 0 ? Math.round((state.totalCorrect/state.totalAnswered)*100) : 0;
  document.getElementById('stats-grid').innerHTML = `
    <div class="stat-card"><div class="stat-card-icon">‚úÖ</div><div class="stat-card-value">${state.totalCorrect}</div><div class="stat-card-label">Acertos</div></div>
    <div class="stat-card"><div class="stat-card-icon">üìä</div><div class="stat-card-value">${accuracy}%</div><div class="stat-card-label">Precis√£o</div></div>
    <div class="stat-card"><div class="stat-card-icon">üî•</div><div class="stat-card-value">${state.maxStreak}</div><div class="stat-card-label">Maior Streak</div></div>
    <div class="stat-card"><div class="stat-card-icon">‚¨ÜÔ∏è</div><div class="stat-card-value">${state.level}</div><div class="stat-card-label">N√≠vel</div></div>
    <div class="stat-card"><div class="stat-card-icon">üìö</div><div class="stat-card-value">${state.totalAnswered}</div><div class="stat-card-label">Respondidas</div></div>
    <div class="stat-card"><div class="stat-card-icon">‚≠ê</div><div class="stat-card-value">${state.xp+(state.level-1)*100}</div><div class="stat-card-label">XP Total</div></div>
  `;

  document.getElementById('cat-progress-list').innerHTML = CATEGORIES.map(cat => {
    const cs = state.catStats[cat.id] || { correct:0, total:0 };
    const pct = cs.total > 0 ? Math.round((cs.correct/cat.words.length)*100) : 0;
    return `
      <div class="cat-progress-item">
        <span class="cat-progress-icon">${cat.icon}</span>
        <div class="cat-progress-info">
          <div class="cat-progress-name">${cat.name}</div>
          <div class="cat-progress-bar-wrap"><div class="cat-progress-bar-fill" style="width:${pct}%;background:linear-gradient(90deg,${cat.color},${cat.color}88)"></div></div>
        </div>
        <div class="cat-progress-num">${cs.correct}/${cat.words.length}</div>
      </div>
    `;
  }).join('');

  document.getElementById('achievements-grid').innerHTML = ACHIEV.map(a => `
    <div class="achievement ${state.unlockedAchievements.includes(a.id) ? 'unlocked' : ''}">
      <div class="achievement-icon">${a.icon}</div>
      <div class="achievement-name">${a.name}</div>
    </div>
  `).join('');
}

// ===== RANKING =====
const FAKE_PLAYERS = [
  {name:'Ana Lima',avatar:'üë©',score:3200,level:14},
  {name:'Carlos R.',avatar:'üë®',score:2500,level:11},
  {name:'Beatriz M.',avatar:'üë©‚Äçü¶±',score:2100,level:10},
  {name:'Pedro H.',avatar:'üßë',score:1700,level:8},
  {name:'Larissa F.',avatar:'üëß',score:1300,level:7},
  {name:'Rafael S.',avatar:'üßî',score:950,level:5},
];

function renderRanking() {
  const myScore = state.xp + (state.level-1)*100 + state.totalCorrect*5;
  const all = [...FAKE_PLAYERS, {name:'Voc√™',avatar:'‚≠ê',score:myScore,level:state.level,isYou:true}]
    .sort((a,b) => b.score - a.score);

  const top3 = all.slice(0,3);
  const podiumOrder = [1,0,2];
  const podiumHeights = [62,85,48];
  const podiumClasses = ['podium-2','podium-1','podium-3'];
  const medals = ['ü•à','ü•á','ü•â'];

  document.getElementById('podium').innerHTML = podiumOrder.map((idx,i) => {
    const p = top3[idx]; if(!p) return '';
    return `
      <div class="podium-place ${podiumClasses[i]}">
        <div class="podium-avatar">${p.avatar}</div>
        <div class="podium-name">${p.name}</div>
        <div class="podium-score">${p.score} XP</div>
        <div class="podium-block" style="height:${podiumHeights[i]}px">${medals[i]}</div>
      </div>
    `;
  }).join('');

  document.getElementById('rank-list').innerHTML = all.map((p,i) => `
    <div class="rank-item ${p.isYou?'is-you':''}">
      <div class="rank-num">${i+1}</div>
      <div class="rank-avatar">${p.avatar}</div>
      <div class="rank-info">
        <div class="rank-name">${p.name}${p.isYou?' (Voc√™)':''}</div>
        <div class="rank-level">N√≠vel ${p.level}</div>
      </div>
      <div class="rank-score">${p.score}</div>
    </div>
  `).join('');
}

// ===== MODE SELECTOR =====
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.currentMode = btn.dataset.mode;
  });
});

// =====================================================
// ============= STUDY SCREEN =========================
// =====================================================

const COLOR_HEX = {
  'Red':'#e74c3c','Yellow':'#f1c40f','Green':'#27ae60','Dark green':'#1a6b3c',
  'Blue':'#2980b9','Dark blue':'#1a3a6b','Lilac':'#c39bd3','Purple':'#8e44ad',
  'Pink':'#ff69b4','Silver':'#bdc3c7','Orange':'#e67e22','Brown':'#795548',
  'Beige':'#d7ccc8','Black':'#1a1a1a','White':'#f5f5f5','Grey':'#9e9e9e',
  'Turquoise':'#1abc9c','Gold':'#d4ac0d','Light blue':'#85c1e9','Light green':'#82e0aa'
};

let studyCatId = null;
let flashIdx = 0;
let flashFlipped = false;
let studyView = 'table';

function openStudyScreen(catId) {
  studyCatId = catId;
  flashIdx = 0;
  flashFlipped = false;
  studyView = 'table';
  const cat = CATEGORIES.find(c => c.id === catId);
  if (!cat) return;
  document.getElementById('study-title').textContent = cat.icon + ' ' + cat.name;
  document.getElementById('study-sub').textContent = cat.words.length + ' palavras';
  renderStudyBody(cat);
  showScreen('study-screen');
}

function startFromStudy() {
  if (studyCatId && !state.selectedCats.includes(studyCatId)) {
    state.selectedCats.push(studyCatId);
    const card = document.getElementById('cat-' + studyCatId);
    if (card) card.classList.add('selected');
    const chk = document.getElementById('cat-check-' + studyCatId);
    if (chk) chk.textContent = '‚úÖ';
    document.getElementById('btn-start').disabled = false;
  }
  startGame();
}

function renderStudyBody(cat) {
  const body = document.getElementById('study-body');
  const cid = cat.id;
  const tActive = studyView==='table' ? 'active' : '';
  const fActive = studyView==='flash' ? 'active' : '';
  let html = `<div class="view-toggle">
    <button class="view-btn ${tActive}" onclick="setStudyView('table','${cid}')">üìã Tabela</button>
    <button class="view-btn ${fActive}" onclick="setStudyView('flash','${cid}')">üÉè Flashcards</button>
  </div>`;

  if (studyView === 'table') {
    html += `<div class="study-search-wrap"><span class="study-search-icon">üîç</span>
      <input class="study-search" id="study-search" type="text" placeholder="Buscar palavra..."
      oninput="filterStudyTable('${cid}', this.value)"></div>`;
  }

  if (studyView === 'flash') {
    html += renderFlashcardView(cat);
  } else if (cat.id === 'alfabeto') {
    html += renderAlphabetView(cat);
  } else if (cat.id === 'cores') {
    html += renderColorsView(cat);
  } else {
    html += renderTableView(cat, '');
  }

  body.innerHTML = html;
}

function setStudyView(view, catId) {
  studyView = view;
  flashIdx = 0;
  flashFlipped = false;
  const cat = CATEGORIES.find(c => c.id === catId);
  if (cat) renderStudyBody(cat);
}

function renderTableView(cat, filter) {
  const words = filter
    ? cat.words.filter(w => w.en.toLowerCase().includes(filter.toLowerCase()) || w.pt.toLowerCase().includes(filter.toLowerCase()))
    : cat.words;
  if (words.length === 0) return '<div style="text-align:center;padding:40px;color:var(--text3);font-weight:600;">Nenhuma palavra encontrada.</div>';
  const rows = words.map(function(w, i) {
    return '<tr class="vocab-row"><td class="cell-num">' + (i+1) + '</td><td class="cell-en">' + w.en + '</td><td class="cell-pron">' + (w.pron||'‚Äî') + '</td><td class="cell-pt">' + w.pt + '</td></tr>';
  }).join('');
  return '<table class="vocab-table" id="study-table"><thead><tr><th>#</th><th>üá∫üá∏ Ingl√™s</th><th>üîä Pron√∫ncia</th><th>üáßüá∑ Portugu√™s</th></tr></thead><tbody>' + rows + '</tbody></table>';
}

function renderAlphabetView(cat) {
  return '<div class="alphabet-grid">' + cat.words.map(function(w) {
    return '<div class="alphabet-card">' +
      '<div class="alpha-letter">' + w.en + '</div>' +
      '<div class="alpha-pron" style="font-size:13px;font-weight:800;color:var(--accent4);">' + w.pt + '</div>' +
      '<div style="font-size:10px;color:var(--text3);margin-top:2px;">som</div>' +
      '</div>';
  }).join('') + '</div>';
}

function renderColorsView(cat) {
  return '<div class="color-grid">' + cat.words.map(function(w) {
    var hex = COLOR_HEX[w.en] || '#888';
    var light = ['White','Yellow','Beige','Silver','Gold','Light blue','Light green'].includes(w.en);
    var tc = light ? '#1a1d2e' : '#fff';
    return '<div class="color-card">' +
      '<div class="color-swatch" style="background:' + hex + ';display:flex;align-items:center;justify-content:center;">' +
      '<span style="color:' + tc + ';font-weight:900;font-size:11px;opacity:0.7;">' + hex + '</span></div>' +
      '<div class="color-card-body"><div class="color-en">' + w.en + '</div><div class="color-pron">' + w.pron + '</div><div class="color-pt">' + w.pt + '</div></div>' +
      '</div>';
  }).join('') + '</div>';
}

function renderFlashcardView(cat) {
  const w = cat.words[flashIdx];
  const total = cat.words.length;
  const cid = cat.id;
  const prevDis = flashIdx===0 ? 'disabled style="opacity:0.3"' : '';
  const nextDis = flashIdx===total-1 ? 'disabled style="opacity:0.3"' : '';
  return `<div class="flashcard-wrap">
    <div class="flashcard ${flashFlipped?'flipped':''}" id="flashcard-el" onclick="flipCard()">
      <div class="flashcard-inner">
        <div class="flashcard-front">
          <div class="fc-word">${w.en}</div>
          ${w.pron ? `<div class="fc-pron">üîä ${w.pron}</div>` : ''}
          <div class="fc-tap" style="margin-top:20px;">üëÜ Toque para ver a tradu√ß√£o</div>
        </div>
        <div class="flashcard-back">
          <div style="font-size:13px;color:var(--text3);margin-bottom:8px;font-weight:600;">Tradu√ß√£o</div>
          <div class="fc-translation">${w.pt}</div>
          ${w.pron ? `<div class="fc-pron" style="font-size:14px;">üîä ${w.pron}</div>` : ''}
        </div>
      </div>
    </div>
    <div class="flashcard-nav">
      <button class="fc-nav-btn" onclick="flashNav(-1)" ${prevDis}>‚Üê</button>
      <div class="fc-counter">${flashIdx+1} / ${total}</div>
      <button class="fc-nav-btn" onclick="flashNav(1)" ${nextDis}>‚Üí</button>
    </div>
    <div style="margin-top:14px;text-align:center;">
      <button class="fc-nav-btn" onclick="shuffleFlash('${cid}')" style="width:auto;padding:0 20px;border-radius:20px;font-size:13px;font-weight:700;color:var(--text2);">üîÄ Embaralhar</button>
    </div>
  </div>`;
}

function flipCard() {
  flashFlipped = !flashFlipped;
  var el = document.getElementById('flashcard-el');
  if (el) el.classList.toggle('flipped', flashFlipped);
}

function flashNav(dir) {
  var cat = CATEGORIES.find(function(c){return c.id===studyCatId;});
  if (!cat) return;
  flashIdx = Math.max(0, Math.min(cat.words.length-1, flashIdx+dir));
  flashFlipped = false;
  renderStudyBody(cat);
}

function shuffleFlash(catId) {
  var cat = CATEGORIES.find(function(c){return c.id===catId;});
  if (!cat) return;
  cat.words = shuffleArray(cat.words);
  flashIdx = 0;
  flashFlipped = false;
  renderStudyBody(cat);
}

function filterStudyTable(catId, query) {
  var cat = CATEGORIES.find(function(c){return c.id===catId;});
  if (!cat) return;
  var table = document.getElementById('study-table');
  if (!table) return;
  var filter = query.toLowerCase();
  var words = filter ? cat.words.filter(function(w){return w.en.toLowerCase().includes(filter)||w.pt.toLowerCase().includes(filter);}) : cat.words;
  var tbody = table.querySelector('tbody');
  if (!tbody) return;
  tbody.innerHTML = words.map(function(w,i) {
    return '<tr class="vocab-row"><td class="cell-num">'+(i+1)+'</td><td class="cell-en">'+hl(w.en,query)+'</td><td class="cell-pron">'+(w.pron||'‚Äî')+'</td><td class="cell-pt">'+hl(w.pt,query)+'</td></tr>';
  }).join('');
}

function hl(text, query) {
  if (!query) return text;
  var re = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + ')', 'gi');
  return text.replace(re, '<mark style="background:rgba(206,130,255,0.3);color:var(--text);border-radius:3px;padding:0 2px;">$1</mark>');
}

// ===== INIT =====
loadState();
renderCategoryList();
updateHUD();
</script>
</body>
</html>
